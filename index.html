<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <title>木木的音乐站 - Mumu Music</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- 圆润可爱字体 -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600&family=Nunito:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <!-- iconfont 图标 -->
    <script src="//at.alicdn.com/t/c/font_2994534_6rijd5vq1f6.js"></script>
    <style>
      /* iconfont 图标样式 */
      .icon {
        width: 1em;
        height: 1em;
        vertical-align: middle;
        fill: currentColor;
        overflow: hidden;
      }
      .btn-icon .icon,
      .play-btn .icon {
        font-size: 1.2em;
      }
      .fullscreen-btn-lg .icon {
        font-size: 1.4em;
      }
      .fullscreen-play-btn .icon {
        font-size: 1.6em;
      }
      :root {
        --bg-dark: #0c0d0f;
        --bg-secondary: #141517;
        --bg-tertiary: #1a1c1f;
        --panel-glass: rgba(20, 21, 23, 0.95);
        --panel-glass-soft: rgba(26, 28, 31, 0.95);
        --accent: #31c27c;
        --accent-strong: #3dd98c;
        --accent-pink: #ff6b9d;
        --accent-blue: #4facfe;
        --accent-green: #31c27c;
        --accent-red: #ff5a5a;
        --accent-yellow: #ffcd32;
        --text-main: #ffffff;
        --text-sub: #8a8a8a;
        --text-third: #5a5a5a;
        --border-subtle: rgba(255, 255, 255, 0.08);
      }

      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        background: var(--bg-dark);
        color: var(--text-main);
        overflow: hidden; /* 页面整体不滚动 */
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI',
          sans-serif;
      }

      /* 背景粒子画布 */
      #bg-canvas {
        position: fixed;
        inset: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
        pointer-events: none;
        background: linear-gradient(135deg, #0c0d0f 0%, #141517 50%, #0c0d0f 100%);
      }

      /* 主容器：四周留白 */
      .app {
        position: relative;
        z-index: 1;
        display: flex;
        flex-direction: column;
        height: calc(100vh - 40px);
        margin: 20px;
        padding: 0;
        gap: 0;
        border-radius: 12px;
        border: 1px solid var(--border-subtle);
        background: var(--bg-secondary);
        backdrop-filter: blur(20px);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        overflow: hidden;
      }
      @media (max-width: 1280px) {
        .app {
          margin: 16px;
          height: calc(100vh - 32px);
        }
      }
      @media (max-width: 900px) {
        .app {
          margin: 10px;
          height: calc(100vh - 20px);
        }
      }
      @media (max-width: 860px) {
        .app {
          height: auto;
          min-height: calc(100vh - 20px);
          margin: 10px;
          padding: 0;
        }
      }

      .ripple-target,
      .btn,
      .track-item,
      .search-mini-item {
        position: relative;
        overflow: hidden;
      }

      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 20px;
        border-radius: 0;
        background: var(--bg-tertiary);
        border: none;
        border-bottom: 1px solid var(--border-subtle);
        box-shadow: none;
        min-height: 60px;
        flex-shrink: 0;
      }

      .logo-area {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .Mumu-box {
        width: 42px;
        height: 42px;
        border-radius: 10px;
        padding: 0;
        background: linear-gradient(135deg, var(--accent) 0%, #28a86b 100%);
        box-shadow: 0 4px 12px rgba(49, 194, 124, 0.3);
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: none;
      }
      .Mumu-img {
        width: 100%;
        height: 100%;
        border-radius: 10px;
        object-fit: cover;
      }

      .title-text h1 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        letter-spacing: 0;
        text-shadow: none;
        color: var(--text-main);
      }
      .title-text p {
        margin: 2px 0 0;
        font-size: 11px;
        color: var(--text-sub);
      }

      .header-controls {
        display: flex;
        align-items: center;
        gap: 16px;
        font-size: 12px;
        color: var(--text-sub);
      }

      .lang-toggle {
        display: inline-flex;
        border-radius: 6px;
        padding: 2px;
        border: 1px solid var(--border-subtle);
        background: var(--bg-dark);
      }
      .lang-btn {
        border: none;
        background: transparent;
        padding: 4px 12px;
        border-radius: 4px;
        color: var(--text-sub);
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .lang-btn.active {
        background: var(--accent);
        color: #fff;
        font-weight: 500;
        box-shadow: none;
      }

      .shortcut-hint {
        max-width: 300px;
        text-align: right;
        font-size: 11px;
      }

      .shortcut-toggle-btn {
        border: none;
        border-radius: 6px;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-dark);
        color: var(--text-sub);
        cursor: pointer;
        box-shadow: none;
        font-size: 14px;
        transition: all 0.2s;
      }
      .shortcut-toggle-btn:hover {
        background: var(--accent);
        color: #fff;
      }

      /* 布局修正：左右也参与分配宽度，不再挤出空白 */
      .layout {
        flex: 1;
        display: grid;
        grid-template-columns:
          minmax(240px, 0.75fr)
          minmax(380px, 1.6fr)
          minmax(260px, 0.85fr);
        gap: 0;
        min-height: 0;
      }

      .panel {
        position: relative;
        display: flex;
        flex-direction: column;
        min-height: 0;
        padding: 16px;
        border-radius: 0;
        background: var(--bg-secondary);
        border: none;
        border-right: 1px solid var(--border-subtle);
        backdrop-filter: none;
        box-shadow: none;
        z-index: 0;
      }
      .panel:last-child {
        border-right: none;
      }
      
      .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        position: relative;
        z-index: 1;
        flex-shrink: 0;
      }
      .panel-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 15px;
        font-weight: 600;
        color: var(--text-main);
      }
      .panel-title .icon {
        font-size: 16px;
        display: inline-flex;
        align-items: center;
      }
      .panel-title .icon svg.icon {
        vertical-align: middle;
      }
      .chip {
        font-size: 11px;
        padding: 4px 10px;
        border-radius: 4px;
        background: var(--bg-dark);
        color: var(--text-sub);
        border: none;
      }

      .btn {
        border: none;
        border-radius: 6px;
        padding: 8px 16px;
        background: var(--accent);
        color: #fff;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        box-shadow: none;
        transition: all 0.2s;
      }
      .btn:hover {
        background: var(--accent-strong);
        transform: translateY(-1px);
      }
      .btn-secondary {
        background: var(--bg-dark);
        color: var(--text-main);
        box-shadow: none;
      }
      .btn-secondary:hover {
        background: var(--bg-tertiary);
      }
      .btn-ghost {
        background: transparent;
        border: 1px solid var(--border-subtle);
        color: var(--text-sub);
        box-shadow: none;
      }
      .btn-ghost:hover {
        border-color: var(--accent);
        color: var(--accent);
      }
      .btn:active {
        transform: translateY(0) scale(0.98);
        box-shadow: none;
      }
      .btn-icon {
        width: 32px;
        height: 32px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        font-size: 14px;
        border-radius: 6px;
      }

      .input {
        flex: 1;
        padding: 10px 14px;
        border-radius: 6px;
        border: 1px solid var(--border-subtle);
        background: var(--bg-dark);
        color: var(--text-main);
        font-size: 13px;
        outline: none;
        transition: all 0.2s;
        -webkit-appearance: none;
        appearance: none;
      }
      .input::placeholder {
        color: var(--text-third);
      }
      .input:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(49, 194, 124, 0.2);
      }
      /* 覆盖浏览器自动填充样式 */
      .input:-webkit-autofill,
      .input:-webkit-autofill:hover,
      .input:-webkit-autofill:focus {
        -webkit-text-fill-color: var(--text-main);
        -webkit-box-shadow: 0 0 0 1000px var(--bg-dark) inset;
        box-shadow: 0 0 0 1000px var(--bg-dark) inset;
        transition: background-color 5000s ease-in-out 0s;
      }

      /* 左侧搜索 */
      .search-panel-content {
        position: relative;
        z-index: 1;
        display: flex;
        flex-direction: column;
        gap: 12px;
        min-height: 0;
      }

      .search-row {
        display: flex;
        align-items: center;
        gap: 0;
        padding: 4px 4px 4px 14px;
        border-radius: 8px;
        background: var(--bg-dark);
        border: 1px solid var(--border-subtle);
        box-shadow: none;
        transition: all 0.2s;
      }
      .search-row:focus-within {
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(49, 194, 124, 0.2);
      }
      .search-prefix {
        font-size: 14px;
        margin-right: 8px;
        color: var(--text-sub);
        text-shadow: none;
        display: inline-flex;
        align-items: center;
      }
      .search-row .input {
        border: none;
        background: transparent;
        box-shadow: none;
        padding-left: 0;
      }
      .search-row .input:focus {
        box-shadow: none;
      }
      .search-row .btn {
        margin-left: 4px;
        border-radius: 6px;
        padding: 8px 16px;
      }

      .source-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        font-size: 12px;
      }
      .source-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 6px;
        background: var(--bg-dark);
        border: 1px solid var(--border-subtle);
        cursor: pointer;
        user-select: none;
        transition: all 0.2s;
      }
      .source-chip:hover {
        border-color: var(--text-third);
      }
      .source-chip input {
        margin: 0;
        width: 14px;
        height: 14px;
        accent-color: var(--accent);
        cursor: pointer;
      }
      .source-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        box-shadow: none;
      }
      .source-dot.migu {
        background: #ff9500;
        color: #ff9500;
      }
      .source-dot.netease {
        background: #e72d2d;
        color: #e72d2d;
      }
      .source-dot.qq {
        background: var(--accent);
        color: var(--accent);
      }
      .source-dot.kuwo {
        background: #ff6b9d;
        color: #ff6b9d;
      }

      .limit-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        font-size: 12px;
        color: var(--text-sub);
      }
      .limit-row select {
        background: var(--bg-dark);
        border-radius: 6px;
        border: 1px solid var(--border-subtle);
        color: var(--text-main);
        padding: 6px 10px;
        font-size: 12px;
        outline: none;
      }

      .search-stats {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: var(--text-sub);
      }

      .search-results-mini {
        flex: 1;
        min-height: 0;
        overflow-y: auto;
        padding-right: 4px;
        margin-top: 8px;
      }

      .search-mini-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 12px;
        margin-bottom: 4px;
        border-radius: 8px;
        background: var(--bg-dark);
        border: 1px solid transparent;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .search-mini-item:hover {
        background: var(--bg-tertiary);
        border-color: var(--border-subtle);
      }
      .mini-meta-main {
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .mini-title {
        font-size: 13px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--text-main);
      }
      .mini-artist {
        font-size: 11px;
        color: var(--text-sub);
        margin-top: 2px;
      }
      .mini-right {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 4px;
      }
      .mini-badge {
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 4px;
        background: var(--bg-tertiary);
        color: var(--text-sub);
        border: none;
      }
      .mini-source {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 10px;
        color: var(--text-sub);
      }

      /* 中间播放器 */
      .player-panel {
        background: var(--bg-secondary);
        display: flex;
        flex-direction: column;
        min-height: 0;
        border-left: 1px solid var(--border-subtle);
        border-right: 1px solid var(--border-subtle);
      }
      .player-top {
        display: flex;
        gap: 16px;
        position: relative;
        z-index: 1;
        min-height: 160px;
        flex-shrink: 0;
      }

      .cover-wrapper {
        width: 140px;
        height: 140px;
        border-radius: 8px;
        overflow: hidden;
        background: var(--bg-dark);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        flex-shrink: 0;
        position: relative;
      }
      .cover-wrapper img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: none;
      }
      .cover-placeholder {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
        color: var(--text-sub);
        font-size: 12px;
      }
      .cover-disc {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: 8px solid var(--bg-tertiary);
        background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-tertiary) 100%);
        position: relative;
        animation: disc-spin 8s linear infinite;
      }
      .cover-disc::before {
        content: '';
        position: absolute;
        inset: 20%;
        border-radius: 50%;
        background: var(--accent);
      }
      .cover-disc::after {
        content: '';
        position: absolute;
        inset: 35%;
        border-radius: 50%;
        background: var(--bg-dark);
      }
      @keyframes disc-spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* 音波动画效果 */
      .audio-wave {
        display: flex;
        align-items: flex-end;
        gap: 3px;
        height: 18px;
        opacity: 0;
        transition: opacity 0.3s;
      }
      .audio-wave.playing {
        opacity: 1;
      }
      .audio-wave .bar {
        width: 3px;
        background: var(--accent);
        border-radius: 2px;
        animation: waveBar 0.6s ease-in-out infinite;
      }
      .audio-wave .bar:nth-child(1) { height: 40%; animation-delay: 0s; }
      .audio-wave .bar:nth-child(2) { height: 70%; animation-delay: 0.1s; }
      .audio-wave .bar:nth-child(3) { height: 50%; animation-delay: 0.2s; }
      .audio-wave .bar:nth-child(4) { height: 80%; animation-delay: 0.15s; }
      .audio-wave .bar:nth-child(5) { height: 60%; animation-delay: 0.25s; }
      @keyframes waveBar {
        0%, 100% { transform: scaleY(0.4); }
        50% { transform: scaleY(1); }
      }

      .player-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .track-title-row {
        display: flex;
        justify-content: space-between;
        gap: 12px;
      }
      .track-text {
        max-width: 70%;
      }
      .track-title {
        font-size: 20px;
        font-weight: 600;
        max-height: 52px;
        overflow: hidden;
        color: var(--text-main);
      }
      .track-artist {
        font-size: 13px;
        color: var(--text-sub);
        margin-top: 4px;
      }
      .track-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 8px;
        font-size: 11px;
      }
      .source-pill {
        padding: 3px 10px;
        border-radius: 4px;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background: var(--bg-dark);
      }
      .source-pill.source-migu {
        color: #ff9500;
        background: rgba(255, 149, 0, 0.15);
      }
      .source-pill.source-netease {
        color: #e72d2d;
        background: rgba(231, 45, 45, 0.15);
      }
      .source-pill.source-qq {
        color: var(--accent);
        background: rgba(49, 194, 124, 0.15);
      }
      .source-pill.source-kuwo {
        color: #ff6b9d;
        background: rgba(255, 107, 157, 0.15);
      }

      .lossless-pill {
        padding: 3px 10px;
        border-radius: 4px;
        border: none;
        color: var(--accent-yellow);
        background: rgba(255, 205, 50, 0.15);
        font-weight: 500;
      }

      .player-actions {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 8px;
        font-size: 12px;
      }
      .player-btn-row {
        display: flex;
        gap: 6px;
      }
      .status-pill {
        padding: 4px 10px;
        border-radius: 4px;
        border: none;
        background: var(--bg-dark);
        color: var(--text-sub);
        font-size: 11px;
      }

      .player-controls {
        margin-top: 8px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .progress-row {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 12px;
      }
      .progress-time {
        width: 44px;
        text-align: center;
        color: var(--text-sub);
        font-family: 'SF Mono', 'Consolas', monospace;
      }
      .progress-bar-wrapper {
        flex: 1;
        height: 4px;
        border-radius: 2px;
        background: var(--bg-dark);
        position: relative;
        cursor: pointer;
        overflow: visible;
      }
      .progress-bar-wrapper:hover {
        height: 6px;
      }
      .progress-bar {
        position: absolute;
        inset: 0;
        transform-origin: left center;
        transform: scaleX(0);
        background: var(--accent);
        border-radius: 2px;
      }
      .progress-handle {
        position: absolute;
        top: 50%;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--accent);
        border: 2px solid #fff;
        transform: translate(-50%, -50%);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        opacity: 0;
        transition: opacity 0.2s;
      }
      .progress-bar-wrapper:hover .progress-handle {
        opacity: 1;
      }

      .control-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
      }
      .control-main {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .control-main .play-btn {
        width: 48px;
        height: 48px;
        font-size: 18px;
        border-radius: 50%;
        background: var(--accent);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
      }
      .control-main .play-btn:hover {
        background: var(--accent-strong);
        transform: scale(1.05);
      }
      .control-secondary {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: var(--text-sub);
      }
      .volume-slider {
        width: 100px;
        accent-color: var(--accent);
      }

      /* 歌词区域 */
      .lyrics-container {
        flex: 1;
        min-height: 0;
        margin-top: 12px;
        padding: 16px 20px;
        border-radius: 8px;
        background: var(--bg-dark);
        border: 1px solid var(--border-subtle);
        overflow-y: auto;
        overflow-x: hidden;
        position: relative;
        box-shadow: none;
      }
      .lyrics-inner {
        position: relative;
        z-index: 1;
        padding: 8px 4px;
        text-align: center;
        max-width: 520px;
        margin: 0 auto;
      }
      .lyrics-title-line {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 13px;
        color: var(--text-sub);
        margin-bottom: 16px;
        letter-spacing: 0;
      }
      .lyrics-line {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 15px;
        color: var(--text-third);
        margin: 6px 0;
        opacity: 0.6;
        transition: all 0.3s ease;
        white-space: normal;
        letter-spacing: 0;
        cursor: pointer;
        user-select: none;
        line-height: 1.8;
      }
      .lyrics-line:hover {
        opacity: 0.85;
        color: var(--text-sub);
      }
      .lyrics-line.active {
        opacity: 1;
        transform: scale(1.08);
        color: var(--accent);
        font-weight: 500;
        text-shadow: 0 0 20px rgba(49, 194, 124, 0.5);
      }
      .lyrics-empty {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 14px;
        color: var(--text-sub);
        margin-top: 20px;
        letter-spacing: 0;
      }

      /* 歌词炫酷效果 (按 L 切换) */
      .lyrics-container.alt-style {
        background: linear-gradient(180deg, rgba(5, 5, 8, 0.98) 0%, rgba(15, 15, 20, 0.98) 100%);
      }
      .lyrics-container.alt-style .lyrics-line {
        font-size: 15px;
        opacity: 0.35;
        color: rgba(255, 255, 255, 0.5);
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        transform: scale(0.95);
      }
      .lyrics-container.alt-style .lyrics-line:hover {
        opacity: 0.6;
        color: rgba(255, 255, 255, 0.7);
        transform: scale(0.98);
      }
      .lyrics-container.alt-style .lyrics-line.active {
        opacity: 1;
        transform: scale(1.12);
        font-size: 18px;
        font-weight: 600;
        color: #fff;
        text-shadow: 
          0 0 10px rgba(49, 194, 124, 0.8),
          0 0 30px rgba(49, 194, 124, 0.6),
          0 0 60px rgba(49, 194, 124, 0.4);
        animation: lyricPulse 1.5s ease-in-out infinite;
      }
      @keyframes lyricPulse {
        0%, 100% {
          text-shadow: 
            0 0 10px rgba(49, 194, 124, 0.8),
            0 0 30px rgba(49, 194, 124, 0.6),
            0 0 60px rgba(49, 194, 124, 0.4);
        }
        50% {
          text-shadow: 
            0 0 15px rgba(49, 194, 124, 1),
            0 0 40px rgba(49, 194, 124, 0.8),
            0 0 80px rgba(49, 194, 124, 0.5),
            0 0 120px rgba(74, 222, 128, 0.3);
        }
      }

      /* 右侧播放列表面板 */
      .playlist-panel {
        background: var(--bg-secondary);
        display: flex;
        flex-direction: column;
        min-height: 0;
        z-index: 1;
        overflow: hidden;
      }

      .playlist-tabs {
        display: inline-flex;
        border-radius: 6px;
        border: 1px solid var(--border-subtle);
        padding: 2px;
        background: var(--bg-dark);
        font-size: 12px;
      }
      .playlist-tab {
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        color: var(--text-sub);
        transition: all 0.2s;
      }
      .playlist-tab:hover {
        color: var(--text-main);
      }
      .playlist-tab.active {
        background: var(--accent);
        color: #fff;
        font-weight: 500;
        box-shadow: none;
      }

      /* 让 playlist-main 内部滚动，顶部条 sticky 不再消失 */
      .playlist-main {
        flex: 1;
        min-height: 0;
        display: flex;
        flex-direction: column;
        position: relative;
        z-index: 1;
        overflow-y: auto;
        padding-right: 4px;
      }

      .playlist-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
        color: var(--text-sub);
        gap: 8px;
        flex-shrink: 0;
        padding: 8px 4px;
        margin-bottom: 8px;
        border-radius: 0;
        position: sticky;
        top: 0;
        z-index: 2;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-subtle);
      }
      .playlist-info {
        flex: 1;
        min-width: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .playlist-right-controls {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .playlist-select-row {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .playlist-select-row select {
        background: var(--bg-dark);
        border-radius: 6px;
        border: 1px solid var(--border-subtle);
        color: var(--text-main);
        padding: 6px 10px;
        font-size: 12px;
        outline: none;
      }

      .playmode-row {
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .playmode-btn {
        border: none;
        border-radius: 6px;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        background: var(--bg-dark);
        color: var(--text-sub);
        cursor: pointer;
        box-shadow: none;
        transition: all 0.2s;
      }
      .playmode-btn:hover {
        color: var(--text-main);
      }
      .playmode-btn.active {
        background: var(--accent);
        color: #fff;
        box-shadow: none;
      }

      .playlist-list {
        flex: 0 0 auto;
        position: relative;
        z-index: 1;
      }

      .track-item {
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 10px;
        align-items: center;
        padding: 10px 12px;
        margin-bottom: 4px;
        border-radius: 8px;
        background: var(--bg-dark);
        border: 1px solid transparent;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .track-item:hover {
        background: var(--bg-tertiary);
        border-color: var(--border-subtle);
      }
      .track-item.playing {
        border-color: var(--accent);
        background: rgba(49, 194, 124, 0.1);
      }
      .track-index {
        width: 24px;
        text-align: right;
        color: var(--text-third);
        font-size: 12px;
      }
      .track-meta-title {
        font-size: 13px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--text-main);
      }
      .track-meta-sub {
        display: flex;
        justify-content: space-between;
        gap: 6px;
        font-size: 11px;
        color: var(--text-sub);
        margin-top: 3px;
      }
      .track-actions {
        display: flex;
        gap: 6px;
        justify-content: flex-end;
      }
      .track-actions .btn-icon {
        width: 28px;
        height: 28px;
        font-size: 12px;
      }
      .btn-fav-active {
        background: var(--accent-red);
        color: #fff;
        box-shadow: none;
      }

      footer {
        font-size: 11px;
        color: var(--text-third);
        text-align: center;
        padding: 12px 16px;
        flex-shrink: 0;
        border-top: 1px solid var(--border-subtle);
        background: var(--bg-tertiary);
      }

      #toast {
        position: fixed;
        left: 50%;
        bottom: 24px;
        transform: translateX(-50%);
        padding: 12px 20px;
        border-radius: 8px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-subtle);
        font-size: 13px;
        color: var(--text-main);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease, transform 0.2s ease;
        z-index: 1500;
      }
      #toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(-4px);
      }

      /* 柔和水波纹：双圈 */
      .ripple-circle,
      .ripple-circle-inner {
        position: absolute;
        border-radius: 50%;
        pointer-events: none;
        transform: translate(-50%, -50%) scale(0);
        opacity: 0.6;
        z-index: 20;
      }

      .ripple-circle {
        border: 2px solid var(--accent);
        box-shadow: 0 0 10px rgba(49, 194, 124, 0.4);
        background: radial-gradient(
          circle,
          rgba(49, 194, 124, 0.2),
          transparent
        );
        animation: rippleOuter 0.6s cubic-bezier(0.22, 0.61, 0.36, 1) forwards;
      }
      .ripple-circle-inner {
        border: 1px solid rgba(49, 194, 124, 0.6);
        box-shadow: 0 0 12px rgba(49, 194, 124, 0.3);
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.15),
          transparent
        );
        animation: rippleInner 0.6s cubic-bezier(0.22, 0.61, 0.36, 1) forwards;
        z-index: 19;
      }
      @keyframes rippleOuter {
        to {
          transform: translate(-50%, -50%) scale(2.2);
          opacity: 0;
        }
      }
      @keyframes rippleInner {
        to {
          transform: translate(-50%, -50%) scale(1.5);
          opacity: 0;
        }
      }

      /* 滚动条 */
      .search-results-mini::-webkit-scrollbar,
      .playlist-main::-webkit-scrollbar,
      .lyrics-container::-webkit-scrollbar {
        width: 6px;
      }
      .search-results-mini::-webkit-scrollbar-track,
      .playlist-main::-webkit-scrollbar-track,
      .lyrics-container::-webkit-scrollbar-track {
        background: var(--bg-dark);
        border-radius: 3px;
      }
      .search-results-mini::-webkit-scrollbar-thumb,
      .playlist-main::-webkit-scrollbar-thumb,
      .lyrics-container::-webkit-scrollbar-thumb {
        border-radius: 3px;
        background: var(--text-third);
      }
      .search-results-mini::-webkit-scrollbar-thumb:hover,
      .playlist-main::-webkit-scrollbar-thumb:hover,
      .lyrics-container::-webkit-scrollbar-thumb:hover {
        background: var(--text-sub);
      }
      .search-results-mini,
      .playlist-main,
      .lyrics-container {
        scrollbar-width: thin;
        scrollbar-color: var(--text-third) var(--bg-dark);
      }

      /* 弹窗 */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(8px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }
      .modal-backdrop.show {
        display: flex;
      }

      .modal {
        background: var(--bg-secondary);
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        max-width: 400px;
        width: 92%;
        color: var(--text-main);
        position: relative;
        border: 1px solid var(--border-subtle);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 16px;
        margin-bottom: 8px;
      }
      .modal-title-wrap {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .modal-title-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        background: var(--accent);
        box-shadow: none;
      }
      .modal-close-btn {
        border: none;
        background: transparent;
        color: var(--text-sub);
        font-size: 20px;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        transition: all 0.2s;
      }
      .modal-close-btn:hover {
        background: var(--bg-dark);
        color: var(--text-main);
      }

      .modal-desc {
        margin: 4px 0 16px;
        font-size: 13px;
        color: var(--text-sub);
      }

      .modal input {
        width: 100%;
        padding: 12px 14px;
        border-radius: 8px;
        border: 1px solid var(--border-subtle);
        background: var(--bg-dark);
        color: var(--text-main);
        font-size: 14px;
        outline: none;
        margin-bottom: 16px;
      }
      .modal input:focus {
        border-color: var(--accent);
      }
      .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 8px;
      }

      /* 歌单选择列表 */
      .playlist-choices {
        max-height: 220px;
        overflow-y: auto;
        margin-bottom: 16px;
        border-radius: 8px;
        background: var(--bg-dark);
        border: 1px solid var(--border-subtle);
      }
      .playlist-choices::-webkit-scrollbar {
        width: 5px;
      }
      .playlist-choices::-webkit-scrollbar-thumb {
        background: var(--text-third);
        border-radius: 3px;
      }
      .playlist-choice-item {
        padding: 14px 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
        color: var(--text-main);
        border-bottom: 1px solid var(--border-subtle);
        transition: all 0.2s;
      }
      .playlist-choice-item:last-child {
        border-bottom: none;
      }
      .playlist-choice-item:hover {
        background: var(--bg-tertiary);
      }
      .playlist-choice-item .choice-icon {
        font-size: 16px;
      }
      .playlist-choice-item .choice-count {
        margin-left: auto;
        font-size: 12px;
        color: var(--text-sub);
      }
      .playlist-choices-empty {
        padding: 24px;
        text-align: center;
        font-size: 13px;
        color: var(--text-sub);
      }

      /* 快捷键说明 */
      .shortcut-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
        margin-top: 12px;
        font-size: 13px;
      }
      .shortcut-card {
        border-radius: 8px;
        padding: 12px;
        background: var(--bg-dark);
        border: 1px solid var(--border-subtle);
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .shortcut-label {
        font-size: 12px;
        color: var(--text-sub);
      }
      .shortcut-key {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
      }
      .shortcut-key kbd {
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid var(--border-subtle);
        font-size: 12px;
        background: var(--bg-tertiary);
        font-family: 'SF Mono', 'Consolas', monospace;
      }

      @media (max-width: 1080px) {
        .layout {
          grid-template-columns: 1fr 1.2fr;
          grid-template-rows: minmax(280px, 1fr) minmax(280px, 1.2fr);
          grid-template-areas:
            'player player'
            'search playlist';
        }
        .search-panel {
          grid-area: search;
        }
        .player-panel {
          grid-area: player;
          border-left: none;
          border-right: none;
          border-bottom: 1px solid var(--border-subtle);
        }
        .playlist-panel {
          grid-area: playlist;
        }
      }
      @media (max-width: 860px) {
        html,
        body {
          overflow: auto;
          overflow-x: hidden;
          -webkit-overflow-scrolling: touch;
        }
        .app {
          height: auto;
          min-height: calc(100vh - 20px);
          margin: 10px;
          padding: 0;
          overflow-x: hidden;
        }
        header {
          flex-direction: row;
          padding: 10px 14px;
          min-height: 50px;
        }
        .Mumu-box {
          width: 36px;
          height: 36px;
        }
        .title-text h1 {
          font-size: 14px;
        }
        .header-controls {
          gap: 10px;
        }
        .shortcut-hint {
          display: none;
        }
        .layout {
          grid-template-columns: 1fr;
          grid-template-rows: auto;
          grid-template-areas:
            'player'
            'search'
            'playlist';
          height: auto;
          overflow: visible;
          display: flex;
          flex-direction: column;
        }
        .panel {
          height: 480px;
          min-height: auto;
          flex-shrink: 0;
          border-right: none;
          border-bottom: 1px solid var(--border-subtle);
        }
        .panel:last-child {
          border-bottom: none;
        }
        .player-panel {
          height: auto;
          min-height: 600px;
          border-left: none;
          border-right: none;
        }
        .player-top {
          min-height: 100px;
          flex-direction: row;
        }
        .cover-wrapper {
          width: 90px;
          height: 90px;
        }
        .cover-disc {
          width: 45px;
          height: 45px;
        }
        .track-title {
          font-size: 16px;
        }
        .volume-slider {
          width: 70px;
        }
        .lyrics-container {
          min-height: 400px;
          max-height: 400px;
          flex: none;
        }
        .lyrics-line {
          font-size: 15px;
          padding: 10px 8px;
        }
        .progress-bar-wrapper {
          width: 150px;
          flex: none;
        }
        .shortcut-grid {
          grid-template-columns: 1fr;
        }
      }
      @media (max-width: 480px) {
        .player-top {
          flex-direction: column;
          align-items: center;
          text-align: center;
        }
        .track-title-row {
          flex-direction: column;
          align-items: center;
        }
        .track-text {
          max-width: 100%;
        }
        .player-actions {
          align-items: center;
        }
        .control-row {
          flex-direction: column;
          gap: 14px;
        }
        .lyrics-container {
          min-height: 400px;
          max-height: 400px;
          padding: 12px 14px;
        }
        .lyrics-line {
          font-size: 14px;
          padding: 8px 6px;
        }
        .lyrics-line.active {
          font-size: 16px;
        }
      }

      /* panel-header-right 样式 */
      .panel-header-right {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      /* 全屏播放页面样式 */
      .fullscreen-player {
        position: fixed;
        inset: 0;
        z-index: 9999;
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      .fullscreen-player.show {
        display: flex;
        opacity: 1;
      }
      .fullscreen-bg {
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, #0a0b0d 0%, #141517 50%, #0a0b0d 100%);
        backdrop-filter: blur(60px);
      }
      .fullscreen-content {
        position: relative;
        z-index: 1;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        padding: 40px 60px;
      }
      .fullscreen-close {
        position: absolute;
        top: 20px;
        right: 30px;
        width: 44px;
        height: 44px;
        border: none;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-main);
        font-size: 20px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .fullscreen-close:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: scale(1.1);
      }
      .fullscreen-main {
        flex: 1;
        display: flex;
        gap: 60px;
        min-height: 0;
        align-items: center;
      }
      .fullscreen-left {
        flex: 0 0 auto;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 30px;
        width: 380px;
      }
      .fullscreen-cover-wrapper {
        width: 320px;
        height: 320px;
        border-radius: 16px;
        overflow: hidden;
        background: var(--bg-dark);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 100px rgba(49, 194, 124, 0.1);
        position: relative;
      }
      .fullscreen-cover {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: none;
      }
      .fullscreen-cover-placeholder {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .fullscreen-cover-placeholder .cover-disc {
        width: 120px;
        height: 120px;
        border-width: 16px;
      }
      .fullscreen-track-info {
        text-align: center;
        max-width: 100%;
      }
      .fullscreen-title {
        font-size: 28px;
        font-weight: 600;
        color: var(--text-main);
        margin-bottom: 8px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .fullscreen-artist {
        font-size: 16px;
        color: var(--text-sub);
        margin-bottom: 12px;
      }
      .fullscreen-tags {
        display: flex;
        justify-content: center;
        gap: 8px;
      }
      .fullscreen-right {
        flex: 1;
        min-width: 0;
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      .fullscreen-lyrics-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px 40px;
        border-radius: 16px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border-subtle);
      }
      .fullscreen-lyrics {
        text-align: center;
        padding: 60px 0;
      }
      .fullscreen-lyrics .lyrics-line {
        font-size: 20px;
        margin: 12px 0;
        padding: 8px 20px;
        line-height: 1.8;
        opacity: 0.5;
        transition: all 0.3s ease;
      }
      .fullscreen-lyrics .lyrics-line:hover {
        opacity: 0.75;
      }
      .fullscreen-lyrics .lyrics-line.active {
        opacity: 1;
        font-size: 26px;
        font-weight: 600;
        color: var(--accent);
        text-shadow: 0 0 30px rgba(49, 194, 124, 0.6);
        transform: scale(1.05);
      }
      .fullscreen-lyrics .lyrics-empty {
        font-size: 18px;
        color: var(--text-sub);
        margin-top: 100px;
      }
      .fullscreen-controls {
        flex-shrink: 0;
        padding-top: 30px;
      }
      .fullscreen-progress-row {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 20px;
      }
      .fullscreen-progress-wrapper {
        flex: 1;
        height: 6px;
        border-radius: 3px;
        background: rgba(255, 255, 255, 0.1);
        position: relative;
        cursor: pointer;
        overflow: visible;
      }
      .fullscreen-progress-wrapper:hover {
        height: 8px;
      }
      .fullscreen-progress-bar {
        position: absolute;
        inset: 0;
        transform-origin: left center;
        transform: scaleX(0);
        background: var(--accent);
        border-radius: 3px;
      }
      .fullscreen-progress-handle {
        position: absolute;
        top: 50%;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: var(--accent);
        border: 3px solid #fff;
        transform: translate(-50%, -50%);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
        opacity: 0;
        transition: opacity 0.2s;
      }
      .fullscreen-progress-wrapper:hover .fullscreen-progress-handle {
        opacity: 1;
      }
      .fullscreen-control-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .fullscreen-control-left,
      .fullscreen-control-right {
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 160px;
      }
      .fullscreen-control-right {
        justify-content: flex-end;
      }
      .fullscreen-control-main {
        display: flex;
        align-items: center;
        gap: 20px;
      }
      .fullscreen-btn-lg {
        width: 50px;
        height: 50px;
        font-size: 20px;
      }
      .fullscreen-play-btn {
        width: 72px;
        height: 72px;
        font-size: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
      }
      .fullscreen-volume {
        width: 120px;
      }

      @media (max-width: 1024px) {
        .fullscreen-content {
          padding: 30px 40px;
        }
        .fullscreen-main {
          flex-direction: column;
          gap: 30px;
          min-height: 0;
          overflow: hidden;
        }
        .fullscreen-left {
          width: 100%;
          flex-direction: row;
          align-items: center;
          gap: 24px;
          flex-shrink: 0;
        }
        .fullscreen-cover-wrapper {
          width: 160px;
          height: 160px;
        }
        .fullscreen-cover-placeholder .cover-disc {
          width: 60px;
          height: 60px;
          border-width: 8px;
        }
        .fullscreen-track-info {
          text-align: left;
          flex: 1;
        }
        .fullscreen-title {
          font-size: 22px;
        }
        .fullscreen-artist {
          font-size: 14px;
        }
        .fullscreen-tags {
          justify-content: flex-start;
        }
        .fullscreen-right {
          flex: 1;
          width: 100%;
          min-height: 0;
          overflow: hidden;
        }
        .fullscreen-lyrics-container {
          padding: 16px 20px;
          height: 100%;
          max-height: 100%;
          overflow-y: auto;
        }
        .fullscreen-lyrics {
          padding: 40vh 0;
        }
        .fullscreen-lyrics .lyrics-line {
          font-size: 16px;
        }
        .fullscreen-lyrics .lyrics-line.active {
          font-size: 20px;
        }
      }

      @media (max-width: 600px) {
        .fullscreen-content {
          padding: 20px;
          padding-top: 50px;
        }
        .fullscreen-close {
          top: 10px;
          right: 15px;
          width: 36px;
          height: 36px;
          font-size: 16px;
        }
        .fullscreen-main {
          flex: 1;
          min-height: 0;
          overflow: hidden;
        }
        .fullscreen-left {
          flex-direction: column;
          gap: 12px;
          flex-shrink: 0;
        }
        .fullscreen-cover-wrapper {
          width: 140px;
          height: 140px;
        }
        .fullscreen-track-info {
          text-align: center;
        }
        .fullscreen-title {
          font-size: 18px;
        }
        .fullscreen-artist {
          font-size: 12px;
        }
        .fullscreen-tags {
          justify-content: center;
        }
        .fullscreen-right {
          flex: 1;
          min-height: 0;
          overflow: hidden;
        }
        .fullscreen-lyrics-container {
          height: 100%;
          max-height: 100%;
          padding: 12px 16px;
          overflow-y: auto;
        }
        .fullscreen-lyrics {
          padding: 40vh 0;
        }
        .fullscreen-lyrics .lyrics-line {
          font-size: 14px;
          margin: 8px 0;
        }
        .fullscreen-lyrics .lyrics-line.active {
          font-size: 16px;
        }
        .fullscreen-controls {
          padding-top: 16px;
        }
        .fullscreen-control-left,
        .fullscreen-control-right {
          min-width: auto;
        }
        .fullscreen-control-right span {
          display: none;
        }
        .fullscreen-volume {
          width: 80px;
        }
        .fullscreen-btn-lg {
          width: 40px;
          height: 40px;
          font-size: 16px;
        }
        .fullscreen-play-btn {
          width: 60px;
          height: 60px;
          font-size: 22px;
        }
      }
    </style>
  </head>
  <body>
    <canvas id="bg-canvas"></canvas>

    <div class="app">
      <header class="ripple-target">
        <div class="logo-area">
          <div class="Mumu-box ripple-target">
            <!-- 请放一张你喜欢的 Mumu.gif 到同目录 -->
            <img src="mumu.gif" alt="Mumu" class="Mumu-img" />
          </div>
          <div class="title-text">
            <h1 data-i18n="appTitle">木木的音乐站</h1>
            <p data-i18n="authorLabel">作者：Mumu </p>
          </div>
        </div>
        <div class="header-controls">
          <div class="lang-toggle ripple-target">
            <button class="lang-btn active" data-lang="zh">中</button>
            <button class="lang-btn" data-lang="en">EN</button>
          </div>
          <div class="shortcut-hint" data-i18n="shortcutHint">
            快捷键：Space 播放/暂停 · ←/→ 跳转 · ↑/↓ 音量 · N/P 切歌 · F 收藏 ·
            L 切换歌词效果
          </div>
          <button
            id="shortcut-toggle-btn"
            class="shortcut-toggle-btn ripple-target"
            title="快捷键说明"
          >
            ⌨️
          </button>
        </div>
      </header>

      <main class="layout">
        <!-- 左：搜索 -->
        <section class="panel search-panel ripple-target">
          <div class="panel-header">
            <div class="panel-title">
              <span class="icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-sousuo"></use></svg></span>
              <span data-i18n="searchTitle">歌曲搜索</span>
            </div>
            <span class="chip" data-i18n="searchSubtitle"
              >支持咪咕 / 网易云 / QQ / 酷我</span
            >
          </div>
          <div class="search-panel-content">
            <div class="search-row ripple-target">
              <span class="search-prefix"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-sousuo"></use></svg></span>
              <input
                id="search-input"
                class="input"
                type="text"
                placeholder="输入歌名 / 歌手，回车搜索…"
              />
              <button
                id="search-btn"
                class="btn ripple-target"
                data-i18n="searchButton"
              >
                搜索
              </button>
            </div>

            <div class="source-row">
              <label class="source-chip ripple-target">
                <span class="source-dot migu"></span>
                <input type="checkbox" data-source="migu" checked />
                <span>咪咕</span>
              </label>
              <label class="source-chip ripple-target">
                <span class="source-dot netease"></span>
                <input type="checkbox" data-source="netease" checked />
                <span>网易云</span>
              </label>
              <label class="source-chip ripple-target">
                <span class="source-dot qq"></span>
                <input type="checkbox" data-source="qq" checked />
                <span>QQ</span>
              </label>
              <label class="source-chip ripple-target">
                <span class="source-dot kuwo"></span>
                <input type="checkbox" data-source="kuwo" checked />
                <span>酷我</span>
              </label>
            </div>

            <div class="limit-row">
              <span data-i18n="perSourceCount">每个源加载</span>
              <select id="limit-select">
                <option value="5">5</option>
                <option value="10" selected>10</option>
                <option value="20">20</option>
                <option value="30">30</option>
              </select>
              <span data-i18n="perSourceCountTail">首结果</span>
              <button
                id="load-more-btn"
                class="btn btn-secondary ripple-target"
                data-i18n="loadMore"
              >
                加载更多
              </button>
            </div>

            <div class="search-stats">
              <span id="search-status" data-i18n="searchStatusIdle"
                >尚未搜索，试试输入“林俊杰”？</span
              >
              <span id="search-count">0</span>
            </div>

            <div id="search-mini-list" class="search-results-mini"></div>
          </div>
        </section>

        <!-- 中：播放器 -->
        <section class="panel player-panel ripple-target">
          <div class="panel-header">
            <div class="panel-title">
              <span class="icon">🎧</span>
              <span data-i18n="playerTitle">正在播放</span>
            </div>
            <div class="panel-header-right">
              <span class="chip" data-i18n="playerSubtitle"
                >歌词动态高亮 · 炫酷霓虹</span
              >
              <button id="fullscreen-player-btn" class="btn btn-secondary btn-icon ripple-target" title="全屏播放">
                ⛶
              </button>
            </div>
          </div>

          <div class="player-top">
            <div class="cover-wrapper">
              <img id="cover-img" src="" alt="cover" />
              <div class="cover-placeholder">
                <div class="cover-disc"></div>
                <div data-i18n="coverHint">搜索并播放一首歌吧！</div>
              </div>
            </div>
            <div class="player-main">
              <div class="track-title-row">
                <div class="track-text">
                  <div id="track-title" class="track-title">暂未选择歌曲</div>
                  <div id="track-artist" class="track-artist"></div>
                  <div class="track-tags">
                    <span
                      id="track-source-pill"
                      class="source-pill"
                      style="display: none"
                    ></span>
                    <span
                      id="track-quality-pill"
                      class="lossless-pill"
                      style="display: none"
                      >超清母带</span
                    >
                  </div>
                </div>
                <div class="player-actions">
                  <div class="player-btn-row">
                    <button
                      id="fav-btn"
                      class="btn btn-secondary btn-icon ripple-target"
                      title="收藏 (F)"
                    >
                      <svg class="icon" aria-hidden="true"><use xlink:href="#icon-xiai"></use></svg>
                    </button>
                    <button
                      id="add-to-playlist-btn"
                      class="btn btn-secondary btn-icon ripple-target"
                      title="添加到歌单"
                    >
                      ＋
                    </button>
                    <button
                      id="download-btn"
                      class="btn btn-secondary btn-icon ripple-target"
                      title="下载"
                    >
                      <svg class="icon" aria-hidden="true"><use xlink:href="#icon-xiazai"></use></svg>
                    </button>
                  </div>
                  <div
                    id="player-status"
                    class="status-pill"
                    data-i18n="playerStatusIdle"
                  >
                    空闲
                  </div>
                  <div id="audio-wave" class="audio-wave">
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                  </div>
                </div>
              </div>

              <div class="player-controls">
                <div class="progress-row">
                  <span id="current-time" class="progress-time">00:00</span>
                  <div
                    id="progress-bar-wrapper"
                    class="progress-bar-wrapper ripple-target"
                  >
                    <div id="progress-bar" class="progress-bar"></div>
                    <div id="progress-handle" class="progress-handle"></div>
                  </div>
                  <span id="total-time" class="progress-time">00:00</span>
                </div>
                <div class="control-row">
                  <div class="control-main">
                    <button
                      id="prev-btn"
                      class="btn btn-secondary btn-icon ripple-target"
                      title="上一首 (P)"
                    >
                      <svg class="icon" aria-hidden="true"><use xlink:href="#icon-shangyishou"></use></svg>
                    </button>
                    <button
                      id="play-btn"
                      class="btn play-btn ripple-target"
                      title="播放/暂停 (Space)"
                    >
                      <svg class="icon" aria-hidden="true"><use xlink:href="#icon-icon_play"></use></svg>
                    </button>
                    <button
                      id="next-btn"
                      class="btn btn-secondary btn-icon ripple-target"
                      title="下一首 (N)"
                    >
                      <svg class="icon" aria-hidden="true"><use xlink:href="#icon-xiayishou"></use></svg>
                    </button>
                  </div>
                  <div class="control-secondary">
                    <span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-yinliang"></use></svg></span>
                    <input
                      id="volume-slider"
                      class="volume-slider"
                      type="range"
                      min="0"
                      max="1"
                      step="0.01"
                      value="0.8"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="lyrics-container">
            <div id="lyrics-inner" class="lyrics-inner">
              <div
                id="lyrics-empty"
                class="lyrics-empty"
                data-i18n="lyricsEmpty"
              >
                暂无歌词，试着播放一首支持歌词的歌曲。
              </div>
            </div>
          </div>

          <audio id="audio" preload="metadata"></audio>
        </section>

        <!-- 右：播放列表 -->
        <section class="panel playlist-panel ripple-target">
          <div class="panel-header">
            <div class="panel-title">
              <span class="icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-20gf-playlistHeart"></use></svg></span>
              <span data-i18n="playlistTitle">播放列表</span>
            </div>
            <div class="playlist-tabs ripple-target">
              <div
                class="playlist-tab active"
                data-tab="results"
                data-i18n="tabResults"
              >
                搜索结果
              </div>
              <div
                class="playlist-tab"
                data-tab="favorites"
                data-i18n="tabFavorites"
              >
                我的收藏
              </div>
              <div
                class="playlist-tab"
                data-tab="playlists"
                data-i18n="tabCustomLists"
              >
                自建歌单
              </div>
            </div>
          </div>

          <div class="playlist-main">
            <div class="playlist-bar">
              <span id="playlist-info" class="playlist-info"></span>
              <div class="playlist-right-controls">
                <div
                  id="playlist-select-row"
                  class="playlist-select-row"
                  style="display: none"
                >
                  <select id="playlist-select"></select>
                  <button
                    id="add-current-btn"
                    class="btn btn-secondary btn-icon ripple-target"
                    title="把当前歌曲加入歌单"
                  >
                    ＋
                  </button>
                  <button
                    id="new-playlist-btn"
                    class="btn btn-ghost ripple-target"
                    data-i18n="newPlaylist"
                  >
                    新建歌单
                  </button>
                </div>
                <div class="playmode-row">
                  <button
                    class="playmode-btn active ripple-target"
                    data-mode="list"
                    title="列表循环"
                  >
                    <svg class="icon" aria-hidden="true"><use xlink:href="#icon-xunhuanbofang-"></use></svg>
                  </button>
                  <button
                    class="playmode-btn ripple-target"
                    data-mode="single"
                    title="单曲循环"
                  >
                    <svg class="icon" aria-hidden="true"><use xlink:href="#icon-danquxunhuan"></use></svg>
                  </button>
                  <button
                    class="playmode-btn ripple-target"
                    data-mode="shuffle"
                    title="随机播放"
                  >
                    <svg class="icon" aria-hidden="true"><use xlink:href="#icon-suijibofang"></use></svg>
                  </button>
                </div>
              </div>
            </div>
            <div id="playlist-list" class="playlist-list"></div>
          </div>
        </section>
      </main>

      <footer>
        <span data-i18n="footerText"
          >本站仅作为学习演示，音乐版权归各平台与原作者所有。</span
        >
      </footer>
    </div>

    <!-- 歌单弹窗 -->
    <div id="playlist-modal" class="modal-backdrop">
      <div class="modal ripple-target">
        <div class="modal-header">
          <div class="modal-title-wrap">
            <div class="modal-title-icon">🎵</div>
            <span data-i18n="modalNewPlaylistTitle">新建歌单</span>
          </div>
          <button id="playlist-close" class="modal-close-btn">×</button>
        </div>
        <p class="modal-desc" data-i18n="modalNewPlaylistDesc">
          给你的歌单取一个可爱的名字吧～
        </p>
        <input
          id="playlist-name-input"
          type="text"
          placeholder="例如：通勤歌单 / 宝可梦歌单"
        />
        <div class="modal-actions">
          <button
            id="playlist-cancel-btn"
            class="btn btn-ghost ripple-target"
            data-i18n="modalCancel"
          >
            取消
          </button>
          <button
            id="playlist-confirm-btn"
            class="btn btn-secondary ripple-target"
            data-i18n="modalConfirm"
          >
            确定
          </button>
        </div>
      </div>
    </div>

    <!-- 添加到歌单弹窗 -->
    <div id="add-to-playlist-modal" class="modal-backdrop">
      <div class="modal ripple-target">
        <div class="modal-header">
          <div class="modal-title-wrap">
            <div class="modal-title-icon">📁</div>
            <span data-i18n="modalAddToPlaylistTitle">添加到歌单</span>
          </div>
          <button id="add-to-playlist-close" class="modal-close-btn">×</button>
        </div>
        <p class="modal-desc" data-i18n="modalAddToPlaylistDesc">
          选择要添加到的歌单：
        </p>
        <div id="playlist-choices" class="playlist-choices"></div>
        <div class="modal-actions">
          <button
            id="add-to-playlist-cancel"
            class="btn btn-ghost ripple-target"
            data-i18n="modalCancel"
          >
            取消
          </button>
          <button
            id="add-to-playlist-new"
            class="btn btn-secondary ripple-target"
            data-i18n="newPlaylist"
          >
            新建歌单
          </button>
        </div>
      </div>
    </div>

    <!-- 快捷键说明弹窗 -->
    <div id="shortcut-modal" class="modal-backdrop">
      <div class="modal ripple-target">
        <div class="modal-header">
          <div class="modal-title-wrap">
            <div class="modal-title-icon">⌨️</div>
            <span data-i18n="shortcutPanelTitle">快捷键说明</span>
          </div>
          <button id="shortcut-close" class="modal-close-btn">×</button>
        </div>
        <p class="modal-desc" data-i18n="shortcutPanelDesc">
          使用键盘可以更加方便地控制木木的音乐站：
        </p>
        <div class="shortcut-grid">
          <div class="shortcut-card">
            <div class="shortcut-label" data-i18n="shortcutPlayPause">
              播放 / 暂停
            </div>
            <div class="shortcut-key"><kbd>Space</kbd></div>
          </div>
          <div class="shortcut-card">
            <div class="shortcut-label" data-i18n="shortcutSeek">
              快退 / 快进 5 秒
            </div>
            <div class="shortcut-key"><kbd>←</kbd><kbd>→</kbd></div>
          </div>
          <div class="shortcut-card">
            <div class="shortcut-label" data-i18n="shortcutVolume">
              音量加 / 减
            </div>
            <div class="shortcut-key"><kbd>↑</kbd><kbd>↓</kbd></div>
          </div>
          <div class="shortcut-card">
            <div class="shortcut-label" data-i18n="shortcutPrevNext">
              上一首 / 下一首
            </div>
            <div class="shortcut-key"><kbd>P</kbd><kbd>N</kbd></div>
          </div>
          <div class="shortcut-card">
            <div class="shortcut-label" data-i18n="shortcutFav">
              收藏 / 取消收藏
            </div>
            <div class="shortcut-key"><kbd>F</kbd></div>
          </div>
          <div class="shortcut-card">
            <div class="shortcut-label" data-i18n="shortcutLyricsFX">
              切换歌词炫酷效果
            </div>
            <div class="shortcut-key"><kbd>L</kbd></div>
          </div>
          <div class="shortcut-card">
            <div class="shortcut-label" data-i18n="shortcutMute">
              静音 / 取消静音
            </div>
            <div class="shortcut-key"><kbd>M</kbd></div>
          </div>
          <div class="shortcut-card">
            <div class="shortcut-label" data-i18n="shortcutFocusSearch">
              聚焦搜索框
            </div>
            <div class="shortcut-key"><kbd>/</kbd></div>
          </div>
        </div>
        <p
          class="modal-desc"
          style="margin-top: 10px"
          data-i18n="shortcutCloseModal"
        >
          提示：按 Esc 可以关闭弹窗。
        </p>
      </div>
    </div>

    <!-- 全屏播放页面 -->
    <div id="fullscreen-player" class="fullscreen-player">
      <div class="fullscreen-bg"></div>
      <div class="fullscreen-content">
        <button id="fullscreen-close" class="fullscreen-close" title="关闭">✕</button>
        
        <div class="fullscreen-main">
          <div class="fullscreen-left">
            <div class="fullscreen-cover-wrapper">
              <img id="fullscreen-cover" class="fullscreen-cover" src="" alt="cover" />
              <div id="fullscreen-cover-placeholder" class="fullscreen-cover-placeholder">
                <div class="cover-disc"></div>
              </div>
            </div>
            <div class="fullscreen-track-info">
              <div id="fullscreen-title" class="fullscreen-title">暂未选择歌曲</div>
              <div id="fullscreen-artist" class="fullscreen-artist"></div>
              <div class="fullscreen-tags">
                <span id="fullscreen-source-pill" class="source-pill" style="display: none"></span>
                <span id="fullscreen-quality-pill" class="lossless-pill" style="display: none">LOSSLESS</span>
              </div>
            </div>
          </div>
          
          <div class="fullscreen-right">
            <div class="fullscreen-lyrics-container">
              <div id="fullscreen-lyrics" class="fullscreen-lyrics"></div>
            </div>
          </div>
        </div>
        
        <div class="fullscreen-controls">
          <div class="fullscreen-progress-row">
            <span id="fullscreen-current-time" class="progress-time">00:00</span>
            <div id="fullscreen-progress-wrapper" class="fullscreen-progress-wrapper">
              <div id="fullscreen-progress-bar" class="fullscreen-progress-bar"></div>
              <div id="fullscreen-progress-handle" class="fullscreen-progress-handle"></div>
            </div>
            <span id="fullscreen-total-time" class="progress-time">00:00</span>
          </div>
          <div class="fullscreen-control-row">
            <div class="fullscreen-control-left">
              <button id="fullscreen-fav-btn" class="btn btn-secondary btn-icon ripple-target" title="收藏"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-xiai"></use></svg></button>
            </div>
            <div class="fullscreen-control-main">
              <button id="fullscreen-prev-btn" class="btn btn-secondary btn-icon fullscreen-btn-lg ripple-target" title="上一首"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-shangyishou"></use></svg></button>
              <button id="fullscreen-play-btn" class="btn play-btn fullscreen-play-btn ripple-target" title="播放/暂停"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-icon_play"></use></svg></button>
              <button id="fullscreen-next-btn" class="btn btn-secondary btn-icon fullscreen-btn-lg ripple-target" title="下一首"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-xiayishou"></use></svg></button>
            </div>
            <div class="fullscreen-control-right">
              <span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-yinliang"></use></svg></span>
              <input id="fullscreen-volume" class="volume-slider fullscreen-volume" type="range" min="0" max="1" step="0.01" value="0.8" />
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="toast"></div>

    <script>
      ;(function () {
        const translations = {
          zh: {
            appTitle: '木木的音乐站 <img src="/image/svip.png" alt="SVIP" style="height: 1em; vertical-align: middle; margin-left: 4px;" />',
            authorLabel: '作者：Mumu',
            shortcutHint:
              '快捷键：Space 播放/暂停 · ←/→ 跳转 · ↑/↓ 音量 · N/P 切歌 · F 收藏 · L 切换歌词效果',
            shortcutPanelTitle: '快捷键说明',
            shortcutPanelDesc: '使用键盘可以更加方便地控制木木的音乐站：',
            shortcutPlayPause: '播放 / 暂停',
            shortcutSeek: '快退 / 快进 5 秒',
            shortcutVolume: '音量加 / 减',
            shortcutPrevNext: '上一首 / 下一首',
            shortcutFav: '收藏 / 取消收藏当前歌曲',
            shortcutLyricsFX: '切换歌词炫酷效果',
            shortcutMute: '静音 / 取消静音',
            shortcutFocusSearch: '聚焦搜索框',
            shortcutCloseModal: '提示：按 Esc 可以关闭弹窗。',
            searchTitle: '歌曲搜索',
            searchSubtitle: '支持咪咕 / 网易云 / QQ / 酷我',
            searchButton: '搜索',
            perSourceCount: '每个源加载',
            perSourceCountTail: '首结果',
            loadMore: '加载更多',
            searchStatusIdle: '尚未搜索，试试输入“林俊杰”？',
            searchStatusSearching: '正在搜索中…',
            searchStatusDone: '搜索完成。',
            searchStatusNoSource: '请至少选择一个音乐源。',
            playerTitle: '正在播放',
            playerSubtitle: '歌词动态高亮 · 炫酷霓虹',
            coverHint: '搜索并播放一首歌吧！',
            playerStatusIdle: '空闲',
            playerStatusLoading: '加载音源中…',
            playerStatusPlaying: '播放中',
            playerStatusPaused: '已暂停',
            lyricsEmpty: '暂无歌词，试着播放一首支持歌词的歌曲。',
            playlistTitle: '播放列表',
            tabResults: '搜索结果',
            tabFavorites: '我的收藏',
            tabCustomLists: '自建歌单',
            playlistInfoResults: '搜索结果列表',
            playlistInfoFavorites: '收藏列表',
            playlistInfoPlaylist: '歌单',
            newPlaylist: '新建歌单',
            footerText: '本站仅作为学习演示，音乐版权归各平台与原作者所有。',
            toastAddedFavorite: '已添加到收藏',
            toastRemovedFavorite: '已从收藏移除',
            toastAddedToPlaylist: '已添加到歌单',
            toastAlreadyInList: '该歌曲已在当前列表里~',
            toastNoMore: '已经没有更多搜索结果啦~',
            toastNeedKeyword: '请先输入搜索关键词。',
            toastSearchError: '搜索时发生了一点小错误，请稍后再试。',
            toastPlayError: '播放失败，请稍后再试。',
            toastLyricStyleSwitched: '已切换歌词炫酷效果。',
            toastDownloadNotReady: '当前歌曲还未加载完成，稍后再试。',
            toastPlaylistCreated: '歌单创建成功。',
            toastPlaylistEmpty: '当前歌单为空，先添加几首歌吧~',
            toastPlaymodeList: '播放模式：列表循环',
            toastPlaymodeSingle: '播放模式：单曲循环',
            toastPlaymodeShuffle: '播放模式：随机播放',
            toastNeedPlaylistSelected: '请先选择一个歌单。',
            toastNoCurrentTrack: '当前没有正在播放的歌曲。',
            sourceMigu: '咪咕',
            sourceNetease: '网易云',
            sourceQQ: 'QQ音乐',
            sourceKuwo: '酷我',
            modalNewPlaylistTitle: '新建歌单',
            modalNewPlaylistDesc: '给你的歌单取一个可爱的名字吧～',
            modalAddToPlaylistTitle: '添加到歌单',
            modalAddToPlaylistDesc: '选择要添加到的歌单：',
            modalAddToPlaylistEmpty: '还没有歌单，先新建一个吧~',
            modalConfirm: '确定',
            modalCancel: '取消'
          },
          en: {
            appTitle: 'Mumu Music Station <img src="/image/svip.png" alt="SVIP" style="height: 1em; vertical-align: middle; margin-left: 4px;" />',
            authorLabel: 'Author: Mumu',
            shortcutHint:
              'Shortcuts: Space Play/Pause · ←/→ Seek · ↑/↓ Volume · N/P Track · F Fav · L Lyrics FX',
            shortcutPanelTitle: 'Keyboard Shortcuts',
            shortcutPanelDesc:
              'Control Mumu Music Station more easily with your keyboard:',
            shortcutPlayPause: 'Play / Pause',
            shortcutSeek: 'Seek backward / forward 5s',
            shortcutVolume: 'Volume up / down',
            shortcutPrevNext: 'Previous / Next track',
            shortcutFav: 'Favorite / unfavorite current track',
            shortcutLyricsFX: 'Toggle lyrics FX',
            shortcutMute: 'Mute / unmute',
            shortcutFocusSearch: 'Focus on search box',
            shortcutCloseModal: 'Tip: press Esc to close dialogs.',
            searchTitle: 'Search',
            searchSubtitle: 'Supports Migu / Netease / QQ / Kuwo',
            searchButton: 'Search',
            perSourceCount: 'Per source',
            perSourceCountTail: 'results',
            loadMore: 'Load more',
            searchStatusIdle: 'No search yet. Try typing "JJ Lin"?',
            searchStatusSearching: 'Searching…',
            searchStatusDone: 'Search completed.',
            searchStatusNoSource: 'Please select at least one music source.',
            playerTitle: 'Now Playing',
            playerSubtitle: 'Dynamic neon lyrics visualizer',
            coverHint: 'Search and play a song!',
            playerStatusIdle: 'Idle',
            playerStatusLoading: 'Loading audio…',
            playerStatusPlaying: 'Playing',
            playerStatusPaused: 'Paused',
            lyricsEmpty: 'No lyrics yet. Try a song with LRC lyrics.',
            playlistTitle: 'Playlists',
            tabResults: 'Default',
            tabFavorites: 'Favorites',
            tabCustomLists: 'Playlists',
            playlistInfoResults: 'Search Result List',
            playlistInfoFavorites: 'Favorites List',
            playlistInfoPlaylist: 'Playlist',
            newPlaylist: 'Create',
            footerText:
              'For demo only. All music copyrights belong to original owners.',
            toastAddedFavorite: 'Added to favorites',
            toastRemovedFavorite: 'Removed from favorites',
            toastAddedToPlaylist: 'Added to playlist',
            toastAlreadyInList: 'This song is already in this list.',
            toastNoMore: 'No more results to load.',
            toastNeedKeyword: 'Please enter a search keyword first.',
            toastSearchError: 'An error occurred while searching.',
            toastPlayError: 'Playback failed. Please try again.',
            toastLyricStyleSwitched: 'Lyrics FX toggled.',
            toastDownloadNotReady:
              'Song not fully loaded yet. Try again later.',
            toastPlaylistCreated: 'Playlist created.',
            toastPlaylistEmpty: 'Playlist is empty. Add some songs first.',
            toastPlaymodeList: 'Play mode: list loop',
            toastPlaymodeSingle: 'Play mode: single loop',
            toastPlaymodeShuffle: 'Play mode: shuffle',
            toastNeedPlaylistSelected: 'Please select a playlist first.',
            toastNoCurrentTrack: 'No track is currently playing.',
            sourceMigu: 'Migu',
            sourceNetease: 'Netease',
            sourceQQ: 'QQ Music',
            sourceKuwo: 'Kuwo',
            modalNewPlaylistTitle: 'Create Playlist',
            modalNewPlaylistDesc: 'Give your playlist a cute name!',
            modalAddToPlaylistTitle: 'Add to Playlist',
            modalAddToPlaylistDesc: 'Choose a playlist:',
            modalAddToPlaylistEmpty: 'No playlists yet. Create one first!',
            modalConfirm: 'Confirm',
            modalCancel: 'Cancel'
          }
        }

        const state = {
          language: 'zh',
          enabledSources: { migu: true, netease: true, qq: true, kuwo: true },
          perSourceLimit: 10,
          perSourceCurrentLimit: { migu: 10, netease: 10, qq: 10, kuwo: 10 },
          // ✅ 仅为“正确加载更多（分页）”新增：网易云使用 page；其他源保持原逻辑（加大 num 再去重）
          perSourcePage: { migu: 1, netease: 1, qq: 1, kuwo: 1 },

          searchKeyword: '',
          searchResults: [],
          trackMap: new Map(),
          favorites: [],
          playlists: [],
          currentTrack: null,
          playContext: { type: 'results', index: -1, playlistId: null },
          playMode: 'list',
          isPlaying: false,
          lyricLines: [],
          currentLyricIndex: -1,
          searchInProgress: false,
          noMoreResults: false,
          lyricsAlt: false,
          muted: false
        }

        const dom = {}
        let audioLevel = 0

        function $(id) {
          return document.getElementById(id)
        }
        function t(k) {
          const lang = state.language
          return (
            (translations[lang] && translations[lang][k]) ||
            translations.zh[k] ||
            k
          )
        }
        function showToast(msg) {
          const toast = $('toast')
          if (!toast) return
          toast.textContent = msg
          toast.classList.add('show')
          setTimeout(() => toast.classList.remove('show'), 2000)
        }
        function formatTime(sec) {
          if (!isFinite(sec) || sec < 0) sec = 0
          const m = Math.floor(sec / 60)
          const s = Math.floor(sec % 60)
          return String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0')
        }

        function getInterleavedSearchList() {
          const grouped = { migu: [], netease: [], qq: [], kuwo: [] }
          state.searchResults.forEach(t => {
            if (grouped[t.source]) grouped[t.source].push(t)
          })
          Object.keys(grouped).forEach(k =>
            grouped[k].sort(
              (a, b) => (a.displayIndex || 0) - (b.displayIndex || 0)
            )
          )
          const order = ['migu', 'netease', 'qq', 'kuwo']
          const idx = { migu: 0, netease: 0, qq: 0, kuwo: 0 }
          const out = []
          let added = true
          while (added) {
            added = false
            for (const s of order) {
              const arr = grouped[s]
              const i = idx[s]
              if (arr && i < arr.length) {
                out.push(arr[i])
                idx[s]++
                added = true
              }
            }
          }
          return out
        }

        function setLanguage(lang) {
          if (lang !== 'zh' && lang !== 'en') lang = 'zh'
          state.language = lang
          try {
            localStorage.setItem('Mumu-music-lang', lang)
          } catch (e) {}
          document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.lang === lang)
          })
          document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.dataset.i18n
            if (key) {
              if (key === 'appTitle') {
                el.innerHTML = t(key)
              } else {
                el.textContent = t(key)
              }
            }
          })
          dom.searchInput.placeholder =
            lang === 'zh'
              ? '输入歌名 / 歌手，回车搜索…'
              : 'Type song / artist, press Enter…'
          dom.playlistNameInput.placeholder =
            lang === 'zh'
              ? '例如：通勤歌单 / 宝可梦歌单'
              : 'e.g. Commute mix / Pokemon list'
          updatePlaylistInfoLabel()
        }

        async function searchMigu(kw, limit) {
          const url = `https://api.xcvts.cn/api/music/migu?gm=${encodeURIComponent(
            kw
          )}&n=&num=${encodeURIComponent(limit)}&type=json`
          let added = 0
          try {
            const res = await fetch(url)
            const json = await res.json()
            if (json.code !== 200 || !Array.isArray(json.data)) return 0
            for (const it of json.data) {
              const n = it.n
              const uid = `migu-${kw}-${n}-${it.title}-${it.singer}`
              if (state.trackMap.has(uid)) continue
              const track = {
                uid,
                source: 'migu',
                displayIndex: n || 0,
                keyword: kw,
                requestNum: limit,
                title: it.title || '',
                artist: it.singer || '',
                album: '',
                cover: null,
                audioUrl: null,
                lrc: null,
                lrcUrl: null,
                detailsLoaded: false,
                quality: 'normal'
              }
              state.trackMap.set(uid, track)
              state.searchResults.push(track)
              added++
            }
          } catch (e) {
            console.error('migu', e)
          }
          return added
        }

        // ✅ 新增：把网易云的 quality 字段映射到 UI 的 “lossless” 标签（仅用于显示）
        function neteaseQualityToTag(q) {
          const s = (q || '').toString().toLowerCase()
          if (
            /lossless|无损|flac|ape|wav|hi-?res|sq|臻品|臻音|高清臻音|spatial/.test(
              s
            )
          )
            return 'lossless'
          return 'normal'
        }

        // ✅ 新增：酷我质量映射（从 kw-api 返回的 quality / url / level.actual 判断）
        function kuwoQualityToTag(qualityStr, urlStr, actualLevel) {
          const s1 = (qualityStr || '').toString().toLowerCase()
          const s2 = (urlStr || '').toString().toLowerCase()
          const s3 = (actualLevel || '').toString().toLowerCase()
          if (s3 === 'zp' || s3 === 'lossless') return 'lossless'
          if (/flac|lossless|无损|超高/.test(s1)) return 'lossless'
          if (s2.endsWith('.flac') || s2.includes('.flac?')) return 'lossless'
          return 'normal'
        }

        // ✅ 替换：网易云搜索改为官方授权 vkeys，且加载更多用 page 正确分页
        async function searchNetease(kw, page, num) {
          const url = `https://api.vkeys.cn/v2/music/netease?word=${encodeURIComponent(
            kw
          )}&page=${encodeURIComponent(page)}&num=${encodeURIComponent(num)}`
          let added = 0
          try {
            const res = await fetch(url)
            const json = await res.json()
            if (json.code !== 200 || !Array.isArray(json.data)) return 0

            json.data.forEach((it, idx) => {
              const songId = it.id
              const uid = `netease-${songId}`
              if (state.trackMap.has(uid)) return

              const track = {
                uid,
                source: 'netease',
                // 用于分组排序：把 page 信息算进去，保证顺序稳定
                displayIndex:
                  (Math.max(1, page) - 1) * Math.max(1, num) + (idx + 1),
                keyword: kw,

                songid: songId,
                title: it.song || '',
                artist: it.singer || '',
                album: it.album || '',

                cover: it.cover || null,
                audioUrl: null,
                lrc: null,
                lrcUrl: null,

                detailsLoaded: false,
                quality: neteaseQualityToTag(it.quality)
              }
              state.trackMap.set(uid, track)
              state.searchResults.push(track)
              added++
            })
          } catch (e) {
            console.error('netease(vkeys)', e)
          }
          return added
        }

        async function searchQQKuwo(kw, limit, source) {
          const url = `https://music-dl.sayqz.com/api?&type=search&keyword=${encodeURIComponent(
            kw
          )}&source=${encodeURIComponent(source)}&limit=${encodeURIComponent(
            limit
          )}`
          let added = 0
          try {
            const res = await fetch(url)
            const json = await res.json()
            if (
              json.code !== 200 ||
              !json.data ||
              !Array.isArray(json.data.results)
            )
              return 0
            for (const it of json.data.results) {
              const uid = `${source}-${it.id}`
              if (state.trackMap.has(uid)) continue

              // ✅ 关键修改（必要）：酷我不直接用 search 返回的 url/lrc，
              //    强制后续走 kw-api.cenguigui.cn 获取播放/下载链接与歌词
              const forceKuwoDetail = source === 'kuwo'

              const track = {
                uid,
                source,
                displayIndex: 0,
                keyword: kw,
                songid: it.id,
                title: it.name || '',
                artist: it.artist || '',
                album: it.album || '',
                cover: it.pic || null,
                audioUrl: forceKuwoDetail ? null : it.url || null,
                lrc: null,
                lrcUrl: forceKuwoDetail ? null : it.lrc || null,
                detailsLoaded: forceKuwoDetail ? false : !!it.url,
                quality: 'normal'
              }
              state.trackMap.set(uid, track)
              state.searchResults.push(track)
              added++
            }
          } catch (e) {
            console.error(source, e)
          }
          return added
        }

        async function searchAllSources(reset) {
          if (!state.searchKeyword) {
            showToast(t('toastNeedKeyword'))
            return
          }
          const enabled = Object.keys(state.enabledSources).filter(
            k => state.enabledSources[k]
          )
          if (!enabled.length) {
            showToast(t('searchStatusNoSource'))
            return
          }
          state.searchInProgress = true
          dom.searchStatus.textContent = t('searchStatusSearching')

          if (reset) {
            Object.keys(state.perSourceCurrentLimit).forEach(
              k => (state.perSourceCurrentLimit[k] = state.perSourceLimit)
            )

            // ✅ 重置分页：网易云回到第 1 页
            Object.keys(state.perSourcePage).forEach(
              k => (state.perSourcePage[k] = 1)
            )

            state.searchResults = []
            state.trackMap.clear()
            state.noMoreResults = false
          }

          const kw = state.searchKeyword
          const tasks = []
          for (const s of enabled) {
            const limit = state.perSourceCurrentLimit[s] || state.perSourceLimit

            if (s === 'migu') tasks.push(searchMigu(kw, limit))

            // ✅ 网易云：用 page + num（每页 num=perSourceLimit）
            if (s === 'netease')
              tasks.push(
                searchNetease(
                  kw,
                  state.perSourcePage.netease || 1,
                  state.perSourceLimit
                )
              )

            if (s === 'qq') tasks.push(searchQQKuwo(kw, limit, 'qq'))
            if (s === 'kuwo') tasks.push(searchQQKuwo(kw, limit, 'kuwo'))
          }
          let added = 0
          try {
            const res = await Promise.all(tasks)
            added = res.reduce((a, b) => a + (b || 0), 0)
          } catch (e) {
            console.error(e)
            showToast(t('toastSearchError'))
          }

          state.searchInProgress = false
          dom.searchStatus.textContent = t('searchStatusDone')
          dom.searchCount.textContent = state.searchResults.length.toString()
          renderMiniSearchList()
          renderPlaylistList()
          if (!state.currentTrack && state.searchResults.length) {
            playFromList('results', 0)
          }
          if (!reset) {
            if (added === 0) {
              state.noMoreResults = true
              showToast(t('toastNoMore'))
            } else state.noMoreResults = false
          }
        }

        async function fetchMiguDetails(track) {
          const num =
            track.requestNum ||
            state.perSourceCurrentLimit.migu ||
            state.perSourceLimit ||
            20
          const url = `https://api.xcvts.cn/api/music/migu?gm=${encodeURIComponent(
            track.keyword
          )}&n=${encodeURIComponent(
            track.displayIndex || 1
          )}&num=${encodeURIComponent(num)}&type=json`
          const res = await fetch(url)
          const j = await res.json()
          if (j.code !== 200) throw new Error('migu detail')

          Object.assign(track, {
            title: j.title || track.title,
            artist: j.singer || track.artist,
            cover: j.cover || track.cover,
            audioUrl: j.music_url || track.audioUrl,
            lrcUrl: j.lrc_url || track.lrcUrl,
            pageUrl: j.link || track.pageUrl,
            detailsLoaded: true
          })

          if (track.lrcUrl && !track.lrc) {
            try {
              const r = await fetch(track.lrcUrl)
              track.lrc = await r.text()
            } catch (e) {}
          }
        }

        // ✅ 替换：网易云详情
        // - 播放/封面：仍用 meting (qijieya)
        // - 歌词：改用 vkeys lyric 接口
        async function fetchNeteaseDetails(track) {
          // 1) meting: 拿播放链接/封面（url/pic）
          const metingApi = `https://api.qijieya.cn/meting/?type=song&id=${encodeURIComponent(
            track.songid
          )}`
          const res = await fetch(metingApi)
          const j = await res.json()
          if (!Array.isArray(j) || !j.length)
            throw new Error('netease meting detail empty')

          const d = j[0] || {}
          Object.assign(track, {
            title: d.name || track.title,
            artist: d.artist || track.artist,
            audioUrl: d.url || track.audioUrl,
            cover: d.pic || track.cover
          })

          // 2) vkeys: 拿歌词（data.lrc）
          const lyricApi = `https://api.vkeys.cn/v2/music/netease/lyric?id=${encodeURIComponent(
            track.songid
          )}`
          try {
            const lr = await fetch(lyricApi)
            const lj = await lr.json()
            if (lj && lj.code === 200 && lj.data) {
              track.lrc = lj.data.lrc || track.lrc || null
              track.lrcUrl = track.lrcUrl || lyricApi
            }
          } catch (e) {
            console.warn('netease(vkeys) lyric fetch failed', e)
          }

          track.detailsLoaded = true
        }

        async function fetchQQDetails(track) {
          if (track.lrcUrl && !track.lrc) {
            try {
              const r = await fetch(track.lrcUrl)
              track.lrc = await r.text()
            } catch (e) {}
          }
          track.detailsLoaded = true
        }

        // ✅ 关键新增：酷我播放/下载/歌词用 kw-api.cenguigui.cn
        async function fetchKuwoDetails(track) {
          const api = `https://kw-api.cenguigui.cn/?id=${encodeURIComponent(
            track.songid
          )}&type=song&level=zp&format=json`
          const res = await fetch(api)
          const j = await res.json()
          if (!j || j.code !== 200 || !j.data)
            throw new Error('kuwo kw-api detail failed')

          const d = j.data
          const actual = d.level && d.level.actual ? d.level.actual : ''
          Object.assign(track, {
            title: d.name || track.title,
            artist: d.artist || track.artist,
            album: d.album || track.album,
            cover: d.pic || track.cover,
            audioUrl: d.url || track.audioUrl,
            lrc: d.lyric || track.lrc || null,
            lrcUrl: null, // kw-api 已直接返回 lyric 字符串
            quality: kuwoQualityToTag(d.quality, d.url, actual),
            detailsLoaded: true
          })
        }

        async function ensureTrackDetails(track) {
          if (
            track.detailsLoaded &&
            track.audioUrl &&
            (track.lrc || !track.lrcUrl)
          )
            return
          dom.playerStatus.textContent = t('playerStatusLoading')
          if (track.source === 'migu') await fetchMiguDetails(track)
          else if (track.source === 'netease') await fetchNeteaseDetails(track)
          else if (track.source === 'kuwo')
            await fetchKuwoDetails(track) // ✅ 酷我改这里
          else await fetchQQDetails(track)
        }

        function parseLRC(txt) {
          if (!txt) return []
          const lines = txt.split(/\r?\n/)
          const reg = /\[(\d{1,2}):(\d{1,2})(?:\.(\d{1,3}))?\]/
          const out = []
          for (const line of lines) {
            const m = reg.exec(line)
            if (!m) continue
            const min = parseInt(m[1], 10) || 0
            const sec = parseInt(m[2], 10) || 0
            const ms = m[3] ? parseInt(m[3].padEnd(3, '0'), 10) : 0
            const time = min * 60 + sec + ms / 1000
            const text = line.replace(reg, '').trim()
            if (text) out.push({ time, text })
          }
          out.sort((a, b) => a.time - b.time)
          return out
        }

        function renderLyrics() {
          const wrap = dom.lyricsInner
          wrap.innerHTML = ''
          state.currentLyricIndex = -1
          const track = state.currentTrack
          const titleLine = document.createElement('div')
          titleLine.className = 'lyrics-title-line'
          if (track) {
            titleLine.textContent =
              (track.title || '') + (track.artist ? ' - ' + track.artist : '')
          }
          wrap.appendChild(titleLine)

          const arr = state.lyricLines
          if (!arr.length) {
            const empty = document.createElement('div')
            empty.id = 'lyrics-empty'
            empty.className = 'lyrics-empty'
            empty.textContent = t('lyricsEmpty')
            wrap.appendChild(empty)
            return
          }
          arr.forEach((ln, i) => {
            const div = document.createElement('div')
            div.className = 'lyrics-line'
            div.dataset.index = i
            div.textContent = ln.text
            // 点击歌词行跳转到对应时间
            div.addEventListener('click', () => {
              if (dom.audio && ln.time !== undefined) {
                dom.audio.currentTime = ln.time
                if (!state.isPlaying) {
                  dom.audio.play()
                  state.isPlaying = true
                  dom.playBtn.innerHTML = '<svg class="icon" aria-hidden="true"><use xlink:href="#icon-zanting"></use></svg>'
                  dom.playerStatus.textContent = t('playerStatusPlaying')
                }
              }
            })
            wrap.appendChild(div)
          })
        }

        function updateLyricsHighlight(time) {
          const lines = state.lyricLines
          if (!lines.length) return
          let idx = state.currentLyricIndex
          if (
            idx < 0 ||
            idx >= lines.length ||
            time < lines[idx].time ||
            (idx + 1 < lines.length && time >= lines[idx + 1].time)
          ) {
            idx = lines.findIndex((l, i) => {
              const nxt = lines[i + 1]
              if (!nxt) return time >= l.time - 0.05
              return time >= l.time - 0.05 && time < nxt.time - 0.05
            })
          }
          if (idx < 0 || idx === state.currentLyricIndex) return
          state.currentLyricIndex = idx
          const wrap = dom.lyricsInner
          wrap
            .querySelectorAll('.lyrics-line.active')
            .forEach(el => el.classList.remove('active'))
          const act = wrap.querySelector(`.lyrics-line[data-index="${idx}"]`)
          if (act) {
            act.classList.add('active')
            const box = dom.lyricsContainer
            box.scrollTo({
              top: act.offsetTop - box.clientHeight * 0.45,
              behavior: 'smooth'
            })
          }
        }

        function isFavorite(track) {
          if (!track) return false
          return state.favorites.some(x => x.uid === track.uid)
        }
        function updateMainFavButton() {
          const tr = state.currentTrack
          const active = isFavorite(tr)
          dom.favBtn.classList.toggle('btn-fav-active', active)
          // 同步更新全屏播放器收藏按钮
          if (dom.fullscreenFavBtn) {
            dom.fullscreenFavBtn.classList.toggle('btn-fav-active', active)
          }
        }

        async function playTrack(track, context) {
          if (!track) return
          state.currentTrack = track
          state.playContext = context || state.playContext

          const applyUI = () => {
            dom.trackTitle.textContent = track.title || ''
            dom.trackArtist.textContent = track.artist || ''

            const sk = track.source
            const key =
              sk === 'migu'
                ? 'sourceMigu'
                : sk === 'netease'
                ? 'sourceNetease'
                : sk === 'qq'
                ? 'sourceQQ'
                : 'sourceKuwo'
            dom.trackSourcePill.style.display = 'inline-flex'
            dom.trackSourcePill.className = 'source-pill source-' + sk
            dom.trackSourcePill.innerHTML = ''
            const dot = document.createElement('span')
            dot.className = 'source-dot ' + sk
            const txt = document.createElement('span')
            txt.textContent = t(key)
            dom.trackSourcePill.appendChild(dot)
            dom.trackSourcePill.appendChild(txt)

            dom.trackQualityPill.style.display =
              track.quality === 'lossless' ? 'inline-block' : 'none'

            if (track.cover) {
              dom.coverImg.src = track.cover
              dom.coverImg.style.display = 'block'
              dom.coverPlaceholder.style.display = 'none'
            } else {
              dom.coverImg.style.display = 'none'
              dom.coverPlaceholder.style.display = 'flex'
            }

            // 同步更新全屏播放器UI
            if (dom.fullscreenPlayer && dom.fullscreenPlayer.classList.contains('show')) {
              updateFullscreenPlayerUI()
            }
          }

          dom.playerStatus.textContent = t('playerStatusLoading')
          applyUI()

          state.lyricLines = track.lrc ? parseLRC(track.lrc) : []
          renderLyrics()
          // 同步更新全屏播放器歌词
          if (dom.fullscreenPlayer && dom.fullscreenPlayer.classList.contains('show')) {
            renderFullscreenLyrics()
          }
          updateMainFavButton()

          try {
            await ensureTrackDetails(track)
            applyUI()
            state.lyricLines = track.lrc ? parseLRC(track.lrc) : []
            renderLyrics()
            // 同步更新全屏播放器歌词
            if (dom.fullscreenPlayer && dom.fullscreenPlayer.classList.contains('show')) {
              renderFullscreenLyrics()
            }
            if (!track.audioUrl) {
              showToast(t('toastPlayError'))
              dom.playerStatus.textContent = t('playerStatusIdle')
              return
            }
            dom.audio.src = track.audioUrl
            await dom.audio.play()
            state.isPlaying = true
            dom.playBtn.innerHTML = '<svg class="icon" aria-hidden="true"><use xlink:href="#icon-zanting"></use></svg>'
            dom.fullscreenPlayBtn.innerHTML = '<svg class="icon" aria-hidden="true"><use xlink:href="#icon-zanting"></use></svg>'
            dom.playerStatus.textContent = t('playerStatusPlaying')
          } catch (e) {
            console.error(e)
            showToast(t('toastPlayError'))
            dom.playerStatus.textContent = t('playerStatusIdle')
          }

          renderMiniSearchList()
          renderPlaylistList()
        }

        function getActiveList() {
          const tp = state.playContext.type
          if (tp === 'results') {
            let list = getInterleavedSearchList()
            if (!list.length && state.searchResults.length) {
              list = [...state.searchResults]
            }
            return list
          }
          if (tp === 'favorites') return state.favorites
          if (tp === 'playlist') {
            const pl = state.playlists.find(
              p => p.id === state.playContext.playlistId
            )
            return pl ? pl.tracks : []
          }
          return getInterleavedSearchList()
        }

        function playFromList(type, index, plId) {
          let list
          if (type === 'results') list = getInterleavedSearchList()
          else if (type === 'favorites') list = state.favorites
          else {
            const pl = state.playlists.find(p => p.id === plId)
            list = pl ? pl.tracks : []
          }
          if (!list.length) {
            if (type !== 'results') showToast(t('toastPlaylistEmpty'))
            return
          }
          if (index < 0) index = list.length - 1
          if (index >= list.length) index = 0
          state.playContext = { type, index, playlistId: plId || null }
          playTrack(list[index], state.playContext)
        }

        function playNext(direction) {
          const list = getActiveList()
          if (!list.length) return
          let idx = state.playContext.index ?? -1
          if (idx < 0 || idx >= list.length) idx = 0

          if (state.playMode === 'single') {
            dom.audio.currentTime = 0
            dom.audio.play().catch(() => {})
            return
          }
          if (state.playMode === 'shuffle') {
            if (list.length === 1) {
              idx = 0
            } else {
              let newIdx
              do {
                newIdx = Math.floor(Math.random() * list.length)
              } while (newIdx === idx)
              idx = newIdx
            }
          } else {
            idx =
              (idx + (direction === 'prev' ? -1 : 1) + list.length) %
              list.length
          }
          playFromList(
            state.playContext.type,
            idx,
            state.playContext.playlistId
          )
        }

        function togglePlayPause() {
          if (!dom.audio.src) return
          if (state.isPlaying) dom.audio.pause()
          else dom.audio.play().catch(e => console.error(e))
        }

        function toggleFavoriteCurrent() {
          const tr = state.currentTrack
          if (!tr) return
          const i = state.favorites.findIndex(x => x.uid === tr.uid)
          if (i >= 0) {
            state.favorites.splice(i, 1)
            showToast(t('toastRemovedFavorite'))
          } else {
            state.favorites.push(tr)
            showToast(t('toastAddedFavorite'))
          }
          updateMainFavButton()
          renderPlaylistList()
          saveFavorites()
        }

        function handleDownloadCurrent() {
          const tr = state.currentTrack
          if (!tr || !tr.audioUrl) {
            showToast(t('toastDownloadNotReady'))
            return
          }
          
          const fileName = `${tr.title || 'Unknown'} - ${tr.artist || 'Unknown'}.mp3`.replace(/[\\/:*?"<>|]/g, '_')
          
          // 由于跨域限制，使用 CORS 代理来下载
          // 这里使用公共的 CORS 代理服务
          const corsProxies = [
            'https://api.codetabs.com/v1/proxy?quest=',
            'https://corsproxy.io/?',
            'https://api.allorigins.win/raw?url='
          ]
          
          const downloadingMsg = state.language === 'zh' ? '下载中，请稍候...' : 'Downloading, please wait...'
          showToast(downloadingMsg)
          
          // 尝试使用代理下载
          async function tryDownloadWithProxy(proxyIndex = 0) {
            if (proxyIndex >= corsProxies.length) {
              // 所有代理都失败了，回退到直接打开链接
              const fallbackMsg = state.language === 'zh' 
                ? '无法直接下载，已在新窗口打开，请手动保存' 
                : 'Cannot download directly, opened in new tab, please save manually'
              showToast(fallbackMsg)
              window.open(tr.audioUrl, '_blank')
              return
            }
            
            const proxyUrl = corsProxies[proxyIndex] + encodeURIComponent(tr.audioUrl)
            
            try {
              const response = await fetch(proxyUrl)
              if (!response.ok) throw new Error('Proxy request failed')
              
              const blob = await response.blob()
              const blobUrl = URL.createObjectURL(blob)
              
              const a = document.createElement('a')
              a.style.display = 'none'
              a.href = blobUrl
              a.download = fileName
              document.body.appendChild(a)
              a.click()
              
              setTimeout(() => {
                document.body.removeChild(a)
                URL.revokeObjectURL(blobUrl)
              }, 100)
              
              const successMsg = state.language === 'zh' ? '下载完成' : 'Download complete'
              showToast(successMsg)
            } catch (error) {
              console.log(`Proxy ${proxyIndex + 1} failed, trying next...`)
              tryDownloadWithProxy(proxyIndex + 1)
            }
          }
          
          tryDownloadWithProxy()
        }

        function addCurrentToPlaylist() {
          const plId = dom.playlistSelect.value
          if (!plId) {
            showToast(t('toastNeedPlaylistSelected'))
            return
          }
          const track = state.currentTrack
          if (!track) {
            showToast(t('toastNoCurrentTrack'))
            return
          }
          const pl = state.playlists.find(p => p.id === plId)
          if (!pl) {
            showToast(t('toastNeedPlaylistSelected'))
            return
          }
          if (pl.tracks.some(tk => tk.uid === track.uid)) {
            showToast(t('toastAlreadyInList'))
            return
          }
          pl.tracks.push(track)
          renderPlaylistList()
          savePlaylists()
          showToast(t('toastAddedToPlaylist'))
        }

        function renderMiniSearchList() {
          const wrap = dom.searchMiniList
          wrap.innerHTML = ''
          const out = getInterleavedSearchList()
          out.forEach((track, i) => {
            const item = document.createElement('div')
            item.className = 'search-mini-item ripple-target'
            const meta = document.createElement('div')
            meta.className = 'mini-meta-main'
            const tt = document.createElement('div')
            tt.className = 'mini-title'
            tt.textContent = track.title || 'Unknown'
            const ar = document.createElement('div')
            ar.className = 'mini-artist'
            ar.textContent = track.artist || ''
            meta.appendChild(tt)
            meta.appendChild(ar)
            const right = document.createElement('div')
            right.className = 'mini-right'
            const badge = document.createElement('div')
            badge.className = 'mini-badge'
            badge.textContent = '#' + (i + 1)
            const src = document.createElement('div')
            src.className = 'mini-source'
            const dot = document.createElement('span')
            dot.className = 'source-dot ' + track.source
            const key =
              track.source === 'migu'
                ? 'sourceMigu'
                : track.source === 'netease'
                ? 'sourceNetease'
                : track.source === 'qq'
                ? 'sourceQQ'
                : 'sourceKuwo'
            const txt = document.createElement('span')
            txt.textContent = t(key)
            src.appendChild(dot)
            src.appendChild(txt)
            right.appendChild(badge)
            right.appendChild(src)
            item.appendChild(meta)
            item.appendChild(right)
            item.addEventListener('click', () => {
              const visible = getInterleavedSearchList()
              const idx = visible.findIndex(x => x.uid === track.uid)
              playFromList('results', idx)
            })
            wrap.appendChild(item)
          })
        }

        function updatePlaylistInfoLabel() {
          const tab =
            document.querySelector('.playlist-tab.active')?.dataset.tab ||
            'results'
          if (tab === 'results')
            dom.playlistInfo.textContent = t('playlistInfoResults')
          else if (tab === 'favorites')
            dom.playlistInfo.textContent = t('playlistInfoFavorites')
          else {
            const pl = state.playlists.find(
              p => p.id === dom.playlistSelect.value
            )
            const base = t('playlistInfoPlaylist')
            dom.playlistInfo.textContent = pl ? base + ' · ' + pl.name : base
          }
        }

        function renderPlaylistList() {
          const wrap = dom.playlistList
          wrap.innerHTML = ''
          const activeTab =
            document.querySelector('.playlist-tab.active')?.dataset.tab ||
            'results'
          let list = []
          if (activeTab === 'results') {
            list = getInterleavedSearchList()
            if (!list.length && state.searchResults.length) {
              list = [...state.searchResults]
            }
            dom.playlistSelectRow.style.display = 'none'
          } else if (activeTab === 'favorites') {
            list = state.favorites
            dom.playlistSelectRow.style.display = 'none'
          } else {
            dom.playlistSelectRow.style.display = 'flex'
            if (!state.playlists.length) {
              dom.playlistSelect.innerHTML = ''
              const opt = document.createElement('option')
              opt.value = ''
              opt.textContent =
                state.language === 'zh' ? '暂无歌单' : 'No playlist'
              dom.playlistSelect.appendChild(opt)
              updatePlaylistInfoLabel()
              return
            }
            if (!dom.playlistSelect.value)
              dom.playlistSelect.value = state.playlists[0].id
            const pl =
              state.playlists.find(p => p.id === dom.playlistSelect.value) ||
              state.playlists[0]
            dom.playlistSelect.value = pl.id
            list = pl.tracks
          }
          updatePlaylistInfoLabel()

          list.forEach((track, idx) => {
            const item = document.createElement('div')
            item.className = 'track-item ripple-target'
            if (state.currentTrack && state.currentTrack.uid === track.uid)
              item.classList.add('playing')

            const index = document.createElement('div')
            index.className = 'track-index'
            index.textContent = idx + 1

            const meta = document.createElement('div')
            const title = document.createElement('div')
            title.className = 'track-meta-title'
            title.textContent = track.title || 'Unknown'
            const sub = document.createElement('div')
            sub.className = 'track-meta-sub'
            const aSpan = document.createElement('span')
            aSpan.textContent = track.artist || ''
            const sSpan = document.createElement('span')
            const dot = document.createElement('span')
            dot.className = 'source-dot ' + track.source
            const key =
              track.source === 'migu'
                ? 'sourceMigu'
                : track.source === 'netease'
                ? 'sourceNetease'
                : track.source === 'qq'
                ? 'sourceQQ'
                : 'sourceKuwo'
            const txt = document.createElement('span')
            txt.textContent = t(key)
            sSpan.appendChild(dot)
            sSpan.appendChild(txt)
            sub.appendChild(aSpan)
            sub.appendChild(sSpan)
            meta.appendChild(title)
            meta.appendChild(sub)

            const act = document.createElement('div')
            act.className = 'track-actions'
            const pBtn = document.createElement('button')
            pBtn.className = 'btn btn-secondary btn-icon ripple-target'
            pBtn.innerHTML = '<svg class="icon" aria-hidden="true"><use xlink:href="#icon-icon_play"></use></svg>'
            const fBtn = document.createElement('button')
            fBtn.className = 'btn btn-secondary btn-icon ripple-target'
            fBtn.innerHTML = '<svg class="icon" aria-hidden="true"><use xlink:href="#icon-xiai"></use></svg>'
            if (isFavorite(track)) fBtn.classList.add('btn-fav-active')

            pBtn.addEventListener('click', ev => {
              ev.stopPropagation()
              if (activeTab === 'results') {
                const visible = getInterleavedSearchList()
                const i = visible.findIndex(x => x.uid === track.uid)
                playFromList('results', i)
              } else if (activeTab === 'favorites') {
                const i = state.favorites.findIndex(x => x.uid === track.uid)
                playFromList('favorites', i)
              } else {
                const plId = dom.playlistSelect.value
                const pl = state.playlists.find(p => p.id === plId)
                const i = pl
                  ? pl.tracks.findIndex(x => x.uid === track.uid)
                  : -1
                playFromList('playlist', i, plId)
              }
            })
            fBtn.addEventListener('click', ev => {
              ev.stopPropagation()
              const i = state.favorites.findIndex(x => x.uid === track.uid)
              if (i >= 0) {
                state.favorites.splice(i, 1)
                showToast(t('toastRemovedFavorite'))
              } else {
                state.favorites.push(track)
                showToast(t('toastAddedFavorite'))
              }
              renderPlaylistList()
              updateMainFavButton()
              saveFavorites()
            })

            item.appendChild(index)
            item.appendChild(meta)
            item.appendChild(act)
            item.addEventListener('click', () => pBtn.click())
            wrap.appendChild(item)
          })
        }

        function openPlaylistModal() {
          dom.playlistModal.classList.add('show')
          dom.playlistNameInput.value = ''
          setTimeout(() => dom.playlistNameInput.focus(), 50)
        }
        function closePlaylistModal() {
          dom.playlistModal.classList.remove('show')
        }

        // ========== 添加到歌单弹窗 ==========
        function openAddToPlaylistModal() {
          const track = state.currentTrack
          if (!track) {
            showToast(t('toastNoCurrentTrack'))
            return
          }
          renderPlaylistChoices()
          dom.addToPlaylistModal.classList.add('show')
        }

        function closeAddToPlaylistModal() {
          dom.addToPlaylistModal.classList.remove('show')
        }

        function renderPlaylistChoices() {
          const wrap = dom.playlistChoices
          wrap.innerHTML = ''
          
          if (!state.playlists.length) {
            const empty = document.createElement('div')
            empty.className = 'playlist-choices-empty'
            empty.textContent = t('modalAddToPlaylistEmpty')
            wrap.appendChild(empty)
            return
          }

          state.playlists.forEach(pl => {
            const item = document.createElement('div')
            item.className = 'playlist-choice-item'
            
            const icon = document.createElement('span')
            icon.className = 'choice-icon'
            icon.textContent = '📁'
            
            const name = document.createElement('span')
            name.textContent = pl.name
            
            const count = document.createElement('span')
            count.className = 'choice-count'
            count.textContent = pl.tracks.length + (state.language === 'zh' ? ' 首' : ' songs')
            
            item.appendChild(icon)
            item.appendChild(name)
            item.appendChild(count)
            
            item.addEventListener('click', () => {
              addTrackToPlaylist(pl.id)
            })
            
            wrap.appendChild(item)
          })
        }

        function addTrackToPlaylist(plId) {
          const track = state.currentTrack
          if (!track) {
            showToast(t('toastNoCurrentTrack'))
            return
          }
          const pl = state.playlists.find(p => p.id === plId)
          if (!pl) return
          
          if (pl.tracks.some(tk => tk.uid === track.uid)) {
            showToast(t('toastAlreadyInList'))
            return
          }
          
          pl.tracks.push(track)
          savePlaylists()
          closeAddToPlaylistModal()
          renderPlaylistList()
          showToast(t('toastAddedToPlaylist'))
        }

        function createPlaylist() {
          let name = dom.playlistNameInput.value.trim()
          if (!name)
            name = state.language === 'zh' ? '未命名歌单' : 'Untitled Playlist'
          const id =
            'pl-' + Date.now() + '-' + Math.random().toString(16).slice(2)
          const pl = { id, name, tracks: [] }
          state.playlists.push(pl)
          const opt = document.createElement('option')
          opt.value = pl.id
          opt.textContent = pl.name
          dom.playlistSelect.appendChild(opt)
          dom.playlistSelect.value = pl.id
          closePlaylistModal()
          renderPlaylistList()
          savePlaylists()
          showToast(t('toastPlaylistCreated'))
        }

        // ========== localStorage 持久化 ==========
        function savePlaylists() {
          try {
            localStorage.setItem('Mumu-music-playlists', JSON.stringify(state.playlists))
          } catch (e) {
            console.warn('保存歌单失败:', e)
          }
        }

        function loadPlaylists() {
          try {
            const data = localStorage.getItem('Mumu-music-playlists')
            if (data) {
              state.playlists = JSON.parse(data)
              // 重建下拉选项
              dom.playlistSelect.innerHTML = ''
              state.playlists.forEach(pl => {
                const opt = document.createElement('option')
                opt.value = pl.id
                opt.textContent = pl.name
                dom.playlistSelect.appendChild(opt)
              })
            }
          } catch (e) {
            console.warn('加载歌单失败:', e)
          }
        }

        function saveFavorites() {
          try {
            localStorage.setItem('Mumu-music-favorites', JSON.stringify(state.favorites))
          } catch (e) {
            console.warn('保存收藏失败:', e)
          }
        }

        function loadFavorites() {
          try {
            const data = localStorage.getItem('Mumu-music-favorites')
            if (data) {
              state.favorites = JSON.parse(data)
            }
          } catch (e) {
            console.warn('加载收藏失败:', e)
          }
        }

        function canAutoLoadMore() {
          return !state.searchInProgress && !state.noMoreResults
        }
        function requestMoreResults() {
          const enabled = Object.keys(state.enabledSources).filter(
            k => state.enabledSources[k]
          )
          if (!enabled.length) return

          enabled.forEach(src => {
            if (src === 'netease') {
              // ✅ 网易云：正确分页，加载下一页
              state.perSourcePage.netease =
                (state.perSourcePage.netease || 1) + 1
            } else {
              // 其他源：保持原逻辑（扩大 num 然后去重）
              state.perSourceCurrentLimit[src] =
                (state.perSourceCurrentLimit[src] || state.perSourceLimit) +
                state.perSourceLimit
            }
          })

          searchAllSources(false)
        }

        function setupParticles() {
          const canvas = $('bg-canvas')
          const ctx = canvas.getContext('2d')
          function resize() {
            const dpr = window.devicePixelRatio || 1
            canvas.width = window.innerWidth * dpr
            canvas.height = window.innerHeight * dpr
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0)
          }
          resize()
          window.addEventListener('resize', resize)
          const parts = []
          const N = 60
          for (let i = 0; i < N; i++) {
            parts.push({
              x: Math.random() * window.innerWidth,
              y: Math.random() * window.innerHeight,
              vx: (Math.random() - 0.5) * 0.25,
              vy: (Math.random() - 0.5) * 0.25,
              r: 1 + Math.random() * 1.5,
              baseR: 1 + Math.random() * 1.5,
              hue: 150 + Math.random() * 40,
              a: 0.15 + Math.random() * 0.2
            })
          }
          let mouse = { x: window.innerWidth / 2, y: window.innerHeight / 2 }
          window.addEventListener('mousemove', e => {
            mouse.x = e.clientX
            mouse.y = e.clientY
          })
          function tick() {
            ctx.clearRect(0, 0, window.innerWidth, window.innerHeight)
            const pulse = 1 + audioLevel * 1.5
            for (const p of parts) {
              p.x += p.vx
              p.y += p.vy
              p.hue += 0.02
              if (p.x < -40) p.x = window.innerWidth + 40
              if (p.x > window.innerWidth + 40) p.x = -40
              if (p.y < -40) p.y = window.innerHeight + 40
              if (p.y > window.innerHeight + 40) p.y = -40
              const dx = p.x - mouse.x,
                dy = p.y - mouse.y
              const dist = Math.sqrt(dx * dx + dy * dy)
              const push = Math.max(0, 140 - dist) / 140
              p.x += dx * 0.008 * push
              p.y += dy * 0.008 * push
              ctx.beginPath()
              ctx.arc(p.x, p.y, p.baseR * pulse, 0, Math.PI * 2)
              const light = Math.min(60, 45 + audioLevel * 30)
              ctx.fillStyle = `hsla(${p.hue},50%,${light}%,${p.a})`
              ctx.fill()
            }
            ctx.lineWidth = 0.3
            for (let i = 0; i < parts.length; i++) {
              for (let j = i + 1; j < parts.length; j++) {
                const a = parts[i],
                  b = parts[j]
                const dx = a.x - b.x,
                  dy = a.y - b.y
                const d = Math.sqrt(dx * dx + dy * dy)
                if (d < 80) {
                  const al = 0.08 * (1 - d / 80) * (0.5 + audioLevel * 1.2)
                  ctx.beginPath()
                  ctx.moveTo(a.x, a.y)
                  ctx.lineTo(b.x, b.y)
                  ctx.strokeStyle = `rgba(49,194,124,${al})`
                  ctx.stroke()
                }
              }
            }
            requestAnimationFrame(tick)
          }
          tick()
        }

        function setupRipple() {
          document.addEventListener('pointerdown', e => {
            const target = e.target.closest(
              '.ripple-target, .btn, .track-item, .search-mini-item'
            )
            if (!target) return
            const rect = target.getBoundingClientRect()
            const x = e.clientX - rect.left,
              y = e.clientY - rect.top
            const max = Math.max(rect.width, rect.height)

            const outer = document.createElement('span')
            outer.className = 'ripple-circle'
            outer.style.left = x + 'px'
            outer.style.top = y + 'px'
            outer.style.width = outer.style.height = max * 2 + 'px'

            const inner = document.createElement('span')
            inner.className = 'ripple-circle-inner'
            inner.style.left = x + 'px'
            inner.style.top = y + 'px'
            inner.style.width = inner.style.height = max * 1.4 + 'px'

            target.appendChild(outer)
            target.appendChild(inner)
            setTimeout(() => outer.remove(), 800)
            setTimeout(() => inner.remove(), 800)
          })
        }

        function setupDOM() {
          dom.searchInput = $('search-input')
          dom.searchBtn = $('search-btn')
          dom.limitSelect = $('limit-select')
          dom.loadMoreBtn = $('load-more-btn')
          dom.searchStatus = $('search-status')
          dom.searchCount = $('search-count')
          dom.searchMiniList = $('search-mini-list')

          dom.coverImg = $('cover-img')
          dom.coverPlaceholder = document.querySelector('.cover-placeholder')
          dom.trackTitle = $('track-title')
          dom.trackArtist = $('track-artist')
          dom.trackSourcePill = $('track-source-pill')
          dom.trackQualityPill = $('track-quality-pill')
          dom.playerStatus = $('player-status')
          dom.audioWave = $('audio-wave')
          dom.playBtn = $('play-btn')
          dom.prevBtn = $('prev-btn')
          dom.nextBtn = $('next-btn')
          dom.favBtn = $('fav-btn')
          dom.downloadBtn = $('download-btn')
          dom.audio = $('audio')
          dom.currentTime = $('current-time')
          dom.totalTime = $('total-time')
          dom.progressWrapper = $('progress-bar-wrapper')
          dom.progressBar = $('progress-bar')
          dom.progressHandle = $('progress-handle')
          dom.volumeSlider = $('volume-slider')
          dom.lyricsInner = $('lyrics-inner')
          dom.lyricsContainer = document.querySelector('.lyrics-container')

          dom.playlistMain = document.querySelector('.playlist-main')
          dom.playlistList = $('playlist-list')
          dom.playlistInfo = $('playlist-info')
          dom.playlistSelectRow = $('playlist-select-row')
          dom.playlistSelect = $('playlist-select')
          dom.newPlaylistBtn = $('new-playlist-btn')
          dom.addCurrentBtn = $('add-current-btn')

          dom.playlistModal = $('playlist-modal')
          dom.playlistNameInput = $('playlist-name-input')
          dom.playlistConfirmBtn = $('playlist-confirm-btn')
          dom.playlistCancelBtn = $('playlist-cancel-btn')
          dom.playlistCloseBtn = $('playlist-close')

          dom.addToPlaylistBtn = $('add-to-playlist-btn')
          dom.addToPlaylistModal = $('add-to-playlist-modal')
          dom.addToPlaylistClose = $('add-to-playlist-close')
          dom.addToPlaylistCancel = $('add-to-playlist-cancel')
          dom.addToPlaylistNew = $('add-to-playlist-new')
          dom.playlistChoices = $('playlist-choices')

          dom.shortcutToggleBtn = $('shortcut-toggle-btn')
          dom.shortcutModal = $('shortcut-modal')
          dom.shortcutCloseBtn = $('shortcut-close')

          // 全屏播放器相关DOM
          dom.fullscreenPlayer = $('fullscreen-player')
          dom.fullscreenClose = $('fullscreen-close')
          dom.fullscreenPlayerBtn = $('fullscreen-player-btn')
          dom.fullscreenCover = $('fullscreen-cover')
          dom.fullscreenCoverPlaceholder = $('fullscreen-cover-placeholder')
          dom.fullscreenTitle = $('fullscreen-title')
          dom.fullscreenArtist = $('fullscreen-artist')
          dom.fullscreenSourcePill = $('fullscreen-source-pill')
          dom.fullscreenQualityPill = $('fullscreen-quality-pill')
          dom.fullscreenLyrics = $('fullscreen-lyrics')
          dom.fullscreenLyricsContainer = document.querySelector('.fullscreen-lyrics-container')
          dom.fullscreenCurrentTime = $('fullscreen-current-time')
          dom.fullscreenTotalTime = $('fullscreen-total-time')
          dom.fullscreenProgressWrapper = $('fullscreen-progress-wrapper')
          dom.fullscreenProgressBar = $('fullscreen-progress-bar')
          dom.fullscreenProgressHandle = $('fullscreen-progress-handle')
          dom.fullscreenPlayBtn = $('fullscreen-play-btn')
          dom.fullscreenPrevBtn = $('fullscreen-prev-btn')
          dom.fullscreenNextBtn = $('fullscreen-next-btn')
          dom.fullscreenFavBtn = $('fullscreen-fav-btn')
          dom.fullscreenVolume = $('fullscreen-volume')
        }

        function setPlaymodeUI() {
          document.querySelectorAll('.playmode-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === state.playMode)
          })
        }

        function setupEvents() {
          document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.addEventListener('click', () => setLanguage(btn.dataset.lang))
          })

          dom.searchBtn.addEventListener('click', () => {
            state.searchKeyword = dom.searchInput.value.trim()
            state.noMoreResults = false
            searchAllSources(true)
          })
          dom.searchInput.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
              state.searchKeyword = dom.searchInput.value.trim()
              state.noMoreResults = false
              searchAllSources(true)
            }
          })

          document.querySelectorAll('.source-chip input').forEach(cb => {
            cb.addEventListener('change', () => {
              state.enabledSources[cb.dataset.source] = cb.checked
            })
          })

          dom.limitSelect.addEventListener('change', () => {
            state.perSourceLimit = parseInt(dom.limitSelect.value, 10) || 10
          })

          dom.loadMoreBtn.addEventListener('click', () => {
            const enabled = Object.keys(state.enabledSources).filter(
              k => state.enabledSources[k]
            )
            if (!enabled.length) {
              showToast(t('searchStatusNoSource'))
              return
            }

            enabled.forEach(s => {
              if (s === 'netease') {
                // ✅ 网易云：正确分页
                state.perSourcePage.netease =
                  (state.perSourcePage.netease || 1) + 1
              } else {
                state.perSourceCurrentLimit[s] =
                  (state.perSourceCurrentLimit[s] || state.perSourceLimit) +
                  state.perSourceLimit
              }
            })

            state.noMoreResults = false
            searchAllSources(false)
          })

          dom.searchMiniList.addEventListener('scroll', () => {
            if (!canAutoLoadMore()) return
            if (
              dom.searchMiniList.scrollTop + dom.searchMiniList.clientHeight >=
              dom.searchMiniList.scrollHeight - 10
            ) {
              requestMoreResults()
            }
          })

          // 监听 playlist-main 的滚动，实现“滚动到底加载更多”
          dom.playlistMain.addEventListener('scroll', () => {
            const activeTab =
              document.querySelector('.playlist-tab.active')?.dataset.tab ||
              'results'
            if (activeTab !== 'results') return
            if (!canAutoLoadMore()) return
            if (
              dom.playlistMain.scrollTop + dom.playlistMain.clientHeight >=
              dom.playlistMain.scrollHeight - 10
            ) {
              requestMoreResults()
            }
          })

          dom.playBtn.addEventListener('click', togglePlayPause)
          dom.prevBtn.addEventListener('click', () => playNext('prev'))
          dom.nextBtn.addEventListener('click', () => playNext('next'))
          dom.favBtn.addEventListener('click', toggleFavoriteCurrent)
          dom.downloadBtn.addEventListener('click', handleDownloadCurrent)

          dom.volumeSlider.addEventListener('input', () => {
            dom.audio.volume = parseFloat(dom.volumeSlider.value)
            dom.fullscreenVolume.value = dom.volumeSlider.value
          })

          dom.audio.addEventListener('timeupdate', () => {
            const cur = dom.audio.currentTime || 0,
              dur = dom.audio.duration || 0
            dom.currentTime.textContent = formatTime(cur)
            dom.totalTime.textContent = formatTime(dur || 0)
            if (dur > 0) {
              const r = cur / dur
              dom.progressBar.style.transform = 'scaleX(' + r + ')'
              const w = dom.progressWrapper.clientWidth
              dom.progressHandle.style.left = w * r + 'px'
            }
            const intensity = Math.abs(Math.sin(cur * 2.3))
            audioLevel = 0.3 + 0.7 * intensity * (dom.audio.volume || 1)
            updateLyricsHighlight(cur)
            // 更新全屏播放器
            updateFullscreenProgress()
            updateFullscreenLyricsHighlight()
          })
          dom.audio.addEventListener('play', () => {
            state.isPlaying = true
            dom.playBtn.innerHTML = '<svg class="icon" aria-hidden="true"><use xlink:href="#icon-zanting"></use></svg>'
            dom.fullscreenPlayBtn.innerHTML = '<svg class="icon" aria-hidden="true"><use xlink:href="#icon-zanting"></use></svg>'
            dom.playerStatus.textContent = t('playerStatusPlaying')
            dom.audioWave.classList.add('playing')
          })
          dom.audio.addEventListener('pause', () => {
            state.isPlaying = false
            dom.playBtn.innerHTML = '<svg class="icon" aria-hidden="true"><use xlink:href="#icon-icon_play"></use></svg>'
            dom.fullscreenPlayBtn.innerHTML = '<svg class="icon" aria-hidden="true"><use xlink:href="#icon-icon_play"></use></svg>'
            dom.playerStatus.textContent = t('playerStatusPaused')
            audioLevel = 0
            dom.audioWave.classList.remove('playing')
          })
          dom.audio.addEventListener('ended', () => {
            audioLevel = 0
            playNext('next')
          })

          dom.progressWrapper.addEventListener('click', e => {
            const rect = dom.progressWrapper.getBoundingClientRect()
            const r = (e.clientX - rect.left) / rect.width
            const dur = dom.audio.duration || 0
            dom.audio.currentTime = Math.max(0, Math.min(dur, dur * r))
          })

          document.querySelectorAll('.playlist-tab').forEach(tab => {
            tab.addEventListener('click', () => {
              document
                .querySelectorAll('.playlist-tab')
                .forEach(el => el.classList.toggle('active', el === tab))
              const tName = tab.dataset.tab
              if (tName === 'results') {
                state.playContext.type = 'results'
                state.playContext.playlistId = null
              } else if (tName === 'favorites') {
                state.playContext.type = 'favorites'
                state.playContext.playlistId = null
              } else {
                state.playContext.type = 'playlist'
                if (state.playlists.length && !state.playContext.playlistId)
                  state.playContext.playlistId = state.playlists[0].id
              }
              renderPlaylistList()
              const list = getActiveList()
              if (!state.currentTrack && list.length)
                playFromList(
                  state.playContext.type,
                  0,
                  state.playContext.playlistId
                )
            })
          })

          dom.newPlaylistBtn.addEventListener('click', openPlaylistModal)
          dom.playlistConfirmBtn.addEventListener('click', createPlaylist)
          dom.playlistCancelBtn.addEventListener('click', closePlaylistModal)
          dom.playlistCloseBtn.addEventListener('click', closePlaylistModal)
          dom.playlistModal.addEventListener('click', e => {
            if (e.target === dom.playlistModal) closePlaylistModal()
          })
          dom.playlistSelect.addEventListener('change', () => {
            state.playContext.playlistId = dom.playlistSelect.value
            renderPlaylistList()
          })
          dom.addCurrentBtn.addEventListener('click', addCurrentToPlaylist)

          // 添加到歌单弹窗相关事件
          dom.addToPlaylistBtn.addEventListener('click', openAddToPlaylistModal)
          dom.addToPlaylistClose.addEventListener('click', closeAddToPlaylistModal)
          dom.addToPlaylistCancel.addEventListener('click', closeAddToPlaylistModal)
          dom.addToPlaylistNew.addEventListener('click', () => {
            closeAddToPlaylistModal()
            openPlaylistModal()
          })
          dom.addToPlaylistModal.addEventListener('click', e => {
            if (e.target === dom.addToPlaylistModal) closeAddToPlaylistModal()
          })

          dom.shortcutToggleBtn.addEventListener('click', () => {
            dom.shortcutModal.classList.add('show')
          })
          dom.shortcutCloseBtn.addEventListener('click', () => {
            dom.shortcutModal.classList.remove('show')
          })
          dom.shortcutModal.addEventListener('click', e => {
            if (e.target === dom.shortcutModal)
              dom.shortcutModal.classList.remove('show')
          })

          document.querySelectorAll('.playmode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              state.playMode = btn.dataset.mode
              setPlaymodeUI()
              if (state.playMode === 'list') showToast(t('toastPlaymodeList'))
              else if (state.playMode === 'single')
                showToast(t('toastPlaymodeSingle'))
              else showToast(t('toastPlaymodeShuffle'))
            })
          })

          document.addEventListener('keydown', e => {
            const tag = document.activeElement.tagName.toLowerCase()
            const typing = tag === 'input' || tag === 'textarea'
            const playlistOpen = dom.playlistModal.classList.contains('show')
            const shortcutOpen = dom.shortcutModal.classList.contains('show')
            const addToPlaylistOpen = dom.addToPlaylistModal.classList.contains('show')

            if (e.key === 'Escape') {
              if (playlistOpen) closePlaylistModal()
              if (shortcutOpen) dom.shortcutModal.classList.remove('show')
              if (addToPlaylistOpen) closeAddToPlaylistModal()
              return
            }

            if (playlistOpen || shortcutOpen || addToPlaylistOpen) {
              return
            }

            if (e.code === 'Space' && !typing) {
              e.preventDefault()
              togglePlayPause()
            }
            if (e.key === 'ArrowRight' && !typing) {
              dom.audio.currentTime = (dom.audio.currentTime || 0) + 5
            }
            if (e.key === 'ArrowLeft' && !typing) {
              dom.audio.currentTime = Math.max(
                0,
                (dom.audio.currentTime || 0) - 5
              )
            }
            if (e.key === 'ArrowUp' && !typing) {
              dom.audio.volume = Math.min(1, (dom.audio.volume || 0) + 0.05)
              dom.volumeSlider.value = dom.audio.volume
            }
            if (e.key === 'ArrowDown' && !typing) {
              dom.audio.volume = Math.max(0, (dom.audio.volume || 0) - 0.05)
              dom.volumeSlider.value = dom.audio.volume
              dom.fullscreenVolume.value = dom.audio.volume
            }
            if ((e.key === 'n' || e.key === 'N') && !typing) playNext('next')
            if ((e.key === 'p' || e.key === 'P') && !typing) playNext('prev')
            if ((e.key === 'f' || e.key === 'F') && !typing)
              toggleFavoriteCurrent()
            if ((e.key === 'l' || e.key === 'L') && !typing) {
              state.lyricsAlt = !state.lyricsAlt
              dom.lyricsContainer.classList.toggle('alt-style', state.lyricsAlt)
              showToast(t('toastLyricStyleSwitched'))
            }
            if ((e.key === 'm' || e.key === 'M') && !typing) {
              state.muted = !state.muted
              dom.audio.muted = state.muted
            }
            if (e.key === '/' && !typing) {
              e.preventDefault()
              dom.searchInput.focus()
              dom.searchInput.select()
            }
          })

          // 全屏播放器事件
          dom.fullscreenPlayerBtn.addEventListener('click', openFullscreenPlayer)
          dom.fullscreenClose.addEventListener('click', closeFullscreenPlayer)
          dom.fullscreenPlayer.addEventListener('click', e => {
            if (e.target === dom.fullscreenPlayer) closeFullscreenPlayer()
          })
          dom.fullscreenPlayBtn.addEventListener('click', togglePlayPause)
          dom.fullscreenPrevBtn.addEventListener('click', () => playNext('prev'))
          dom.fullscreenNextBtn.addEventListener('click', () => playNext('next'))
          dom.fullscreenFavBtn.addEventListener('click', toggleFavoriteCurrent)
          dom.fullscreenVolume.addEventListener('input', () => {
            dom.audio.volume = parseFloat(dom.fullscreenVolume.value)
            dom.volumeSlider.value = dom.fullscreenVolume.value
          })
          dom.fullscreenProgressWrapper.addEventListener('click', e => {
            const rect = dom.fullscreenProgressWrapper.getBoundingClientRect()
            const r = (e.clientX - rect.left) / rect.width
            const dur = dom.audio.duration || 0
            dom.audio.currentTime = Math.max(0, Math.min(dur, dur * r))
          })
          // Esc 关闭全屏播放器
          document.addEventListener('keydown', e => {
            if (e.key === 'Escape' && dom.fullscreenPlayer.classList.contains('show')) {
              closeFullscreenPlayer()
            }
          })
        }

        // 全屏播放器函数
        function openFullscreenPlayer() {
          updateFullscreenPlayerUI()
          renderFullscreenLyrics()
          dom.fullscreenPlayer.classList.add('show')
          document.body.style.overflow = 'hidden'
        }

        function closeFullscreenPlayer() {
          dom.fullscreenPlayer.classList.remove('show')
          document.body.style.overflow = ''
        }

        function updateFullscreenPlayerUI() {
          const track = state.currentTrack
          if (!track) {
            dom.fullscreenTitle.textContent = state.language === 'zh' ? '暂未选择歌曲' : 'No track selected'
            dom.fullscreenArtist.textContent = ''
            dom.fullscreenCover.style.display = 'none'
            dom.fullscreenCoverPlaceholder.style.display = 'flex'
            dom.fullscreenSourcePill.style.display = 'none'
            dom.fullscreenQualityPill.style.display = 'none'
            return
          }

          dom.fullscreenTitle.textContent = track.title || ''
          dom.fullscreenArtist.textContent = track.artist || ''

          if (track.cover) {
            dom.fullscreenCover.src = track.cover
            dom.fullscreenCover.style.display = 'block'
            dom.fullscreenCoverPlaceholder.style.display = 'none'
          } else {
            dom.fullscreenCover.style.display = 'none'
            dom.fullscreenCoverPlaceholder.style.display = 'flex'
          }

          // 来源标签
          const sk = track.source
          const key = sk === 'migu' ? 'sourceMigu'
            : sk === 'netease' ? 'sourceNetease'
            : sk === 'qq' ? 'sourceQQ'
            : 'sourceKuwo'
          dom.fullscreenSourcePill.style.display = 'inline-flex'
          dom.fullscreenSourcePill.className = 'source-pill source-' + sk
          dom.fullscreenSourcePill.innerHTML = ''
          const dot = document.createElement('span')
          dot.className = 'source-dot ' + sk
          const txt = document.createElement('span')
          txt.textContent = t(key)
          dom.fullscreenSourcePill.appendChild(dot)
          dom.fullscreenSourcePill.appendChild(txt)

          // 音质标签
          dom.fullscreenQualityPill.style.display = track.quality === 'lossless' ? 'inline-block' : 'none'

          // 播放状态
          dom.fullscreenPlayBtn.innerHTML = state.isPlaying ? '<svg class="icon" aria-hidden="true"><use xlink:href="#icon-zanting"></use></svg>' : '<svg class="icon" aria-hidden="true"><use xlink:href="#icon-icon_play"></use></svg>'

          // 收藏按钮状态
          dom.fullscreenFavBtn.classList.toggle('btn-fav-active', isFavorite(track))

          // 音量同步
          dom.fullscreenVolume.value = dom.audio.volume
        }

        function renderFullscreenLyrics() {
          const wrap = dom.fullscreenLyrics
          wrap.innerHTML = ''

          if (!state.lyricLines.length) {
            const empty = document.createElement('div')
            empty.className = 'lyrics-empty'
            empty.textContent = t('lyricsEmpty')
            wrap.appendChild(empty)
            return
          }

          state.lyricLines.forEach((line, idx) => {
            const div = document.createElement('div')
            div.className = 'lyrics-line'
            div.dataset.index = idx
            div.textContent = line.text
            div.addEventListener('click', () => {
              dom.audio.currentTime = line.time
            })
            wrap.appendChild(div)
          })

          // 高亮当前歌词
          updateFullscreenLyricsHighlight()
        }

        function updateFullscreenLyricsHighlight() {
          if (!dom.fullscreenPlayer.classList.contains('show')) return

          const cur = dom.audio.currentTime || 0
          let idx = -1
          for (let i = 0; i < state.lyricLines.length; i++) {
            if (state.lyricLines[i].time <= cur) idx = i
            else break
          }

          const wrap = dom.fullscreenLyrics
          wrap.querySelectorAll('.lyrics-line.active').forEach(el => el.classList.remove('active'))

          if (idx >= 0) {
            const act = wrap.querySelector(`.lyrics-line[data-index="${idx}"]`)
            if (act) {
              act.classList.add('active')
              const container = dom.fullscreenLyricsContainer
              container.scrollTo({
                top: act.offsetTop - container.clientHeight * 1,
                behavior: 'smooth'
              })
            }
          }
        }

        function updateFullscreenProgress() {
          if (!dom.fullscreenPlayer.classList.contains('show')) return

          const cur = dom.audio.currentTime || 0
          const dur = dom.audio.duration || 0
          dom.fullscreenCurrentTime.textContent = formatTime(cur)
          dom.fullscreenTotalTime.textContent = formatTime(dur)

          if (dur > 0) {
            const r = cur / dur
            dom.fullscreenProgressBar.style.transform = 'scaleX(' + r + ')'
            const w = dom.fullscreenProgressWrapper.clientWidth
            dom.fullscreenProgressHandle.style.left = w * r + 'px'
          }
        }

        function init() {
          setupDOM()
          try {
            const lg = localStorage.getItem('Mumu-music-lang')
            if (lg) state.language = lg
          } catch (e) {}
          // 加载持久化的歌单和收藏
          loadPlaylists()
          loadFavorites()
          setupParticles()
          setupRipple()
          setupEvents()
          setLanguage(state.language)
          setPlaymodeUI()
          dom.audio.volume = parseFloat(dom.volumeSlider.value)
          // 初始化后渲染一次歌单列表
          renderPlaylistList()
        }

        document.addEventListener('DOMContentLoaded', init)
      })()
    </script>
  </body>
</html>